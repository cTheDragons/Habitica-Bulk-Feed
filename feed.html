<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Bulk Feed Pets Tool</title>
    <base target="_blank">

<!--

This code is licensed under the same terms as Habitica:
    https://raw.githubusercontent.com/HabitRPG/habitrpg/develop/LICENSE

https://github.com/Alys/tools-for-habitrpg/blob/master/habitrpg_user_data_display.html

https://oldgods.net/habitica/cTheDragons/feed.html

Contributors:
    cTheDragons https://github.com/cTheDragons
	based on code from
	Alys (Alice Harris), lady_alys@oldgods.net https://github.com/Alys
    thepeopleseason (James Hsiao) https://github.com/thepeopleseason
    goldfndr (Richard Finegold) https://github.com/goldfndr
    Blade Barringer https://github.com/crookedneighbor
    donoftime https://github.com/donoftime
    me_and (Adam Dinwoodie) https://github.com/me-and
	

-->


    <meta name="description" content="Bulk Feed Pets Tool" />
    <meta name="author" content="cTheDragons" />

	
	

	<script src="https://code.jquery.com/jquery-1.12.3.js"></script> <!--- jquery -->
	<script src="https://momentjs.com/downloads/moment-with-locales.min.js"></script> <!--- time functions -->
	<script src="js/habitica-markdown.min.js"></script> <!--- Markdown -->

	 <!--- https://datatables.net/download/ -->
	<script type="text/javascript" src="https://cdn.datatables.net/v/dt/jszip-2.5.0/pdfmake-0.1.18/dt-1.10.12/b-1.2.2/b-colvis-1.2.2/b-flash-1.2.2/b-html5-1.2.2/b-print-1.2.2/se-1.2.0/datatables.min.js"></script>
	<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/v/dt/jszip-2.5.0/pdfmake-0.1.18/dt-1.10.12/b-1.2.2/b-colvis-1.2.2/b-flash-1.2.2/b-html5-1.2.2/b-print-1.2.2/se-1.2.0/datatables.min.css"/>
 	
<script type="text/javascript">
$(function() { // wraps around all our code to not pollute global namespace

//////////////////////////////////////////////////////////////////////
////   Global Variables                              /////////////////
//////////////////////////////////////////////////////////////////////

var content;  // holds site-wide content (gear names and stats, quests, etc)
var user;     // holds user's data
var pets;	  // holds all pets
var eggs;	  // holds all eggs
var potions;	  // holds all potions
var food;	  // holds all food
var sellItems; //holds all items to sell
var actionLog; 		//log that holds all the data from feeding/hatching pets
var triadBingoRequirement; //holds the requirements for Triad Bingo
var canTriadBingo;
var userIsAdmin; 
var multiStep;
var multiStepArray = []; //For completing multiple different actions

//////////////////////////////////////////////////////////////////////
////   Global Constants                              /////////////////
//////////////////////////////////////////////////////////////////////
var DOUBLEQUOTES = 		'"' //This is to make my life easier... 
var SECTIONREFRESH = 	"SectionRefresh"



//////////////////////////////////////////////////////////////////////
////   Sections                              /////////////////
//////////////////////////////////////////////////////////////////////

		// TO ADD NEW SECTION: To create a Table of Content entry and Main,
		// add the unique identifier for the new section to array section to Display. 
		// If it is a section that displays table content update sectionTables too. 
		// If new content is required see formatAllDataAndCollate() 
		
		//If custom sections required add to below the Sections data... (Not there yet)


//index array for looping
var dashboardToDisplay = [
/*	{id: 'petToFeedCount', label: 'Total Pets To Feed', hoverText: 'Total number of pets hatched before hatching a mount.', value: 'user.feedStats.petFeedCount', status: 'neutral', showOnly: []},
	{id: 'mountCount', label: 'Total Mounts', hoverText: 'Total number of mounts.', value: 'user.mountCount', value: 'user.feedStats.mountCount', status: 'neutral', showOnly: []},
	{id: 'petNoFeedCount', label: 'Total Pets ReGen', hoverText: 'Total number of pets hatched after already hatching a mount.', value: 'user.feedStats.petNoFeedCount', status: 'neutral', showOnly: []},
	{id: 'petRareCount', label: 'Rare Pets Count', hoverText: 'Total number of rare Feed', value: 'user.feedStats.petRareCount', status: 'danger', showOnly: []},
	{id: 'mountRareCount', label: 'Rare Mount Count', hoverText: 'Total number of rare Mounts', value: 'user.feedStats.mountRareCount', status: 'danger', showOnly: []},
	{id: 'petToFeedBaseCount', label: 'Base Pets To Feed', hoverText: 'Total number of base pets hatched before hatching a mount.', value: 'user.feedStats.petFeedBaseCount', status: 'safe', showOnly: []},
	{id: 'mountBaseCount', label: 'Base Mounts', hoverText: 'Total number of base mounts.', status: 'safe',  value: 'user.feedStats.mountBaseCount', showOnly: []},
	{id: 'petNoFeedBaseCount', label: 'Base Pets ReGen', hoverText: 'Total number of base pets hatched after already hatching a mount.', value: 'user.feedStats.petNoFeedBaseCount', status: 'safe', showOnly: []},
	{id: 'eggBaseCount', label: 'Base Eggs', hoverText: 'Total Base Eggs (ignoring excess quantity)', value: 'user.feedStats.eggBaseCount', status: 'safe', showOnly: []},
	{id: 'potionBaseCount', label: 'Base Potions', hoverText: 'Total Base Potions (ignoring excess quantity)', value: 'user.feedStats.potionBaseCount', status: 'safe', showOnly: []},
*/
]


var sectionsToDisplay = [	
	{type: 'heading', id: 'headingGroup01', title: 'Action', showOnly: [], description: ''},
		{type: 'sectionTable', id: 'pets', title: 'Pets', showOnly: [], description: 'Shows the status of your pets. This section will allow you to bulk hatch, bulk feed your pets a specific food or bulk feed with ideal food. The table allows for multiple select so you can do this for more than one pet at once.'},
		{type: 'sectionTable', id: 'triadBingoRequirement', title: 'Triad Bingo', showOnly: [], description: 'Either allows you to hatch all items for Triad Bingo or show which items are missing.'},
		{type: 'sectionTable', id: 'sellItems', title: 'Sell Items', showOnly: [], description: 'Allows you to sell food, eggs or hatching potions.'},
	{type: 'heading', id: 'headingGroup2', title: 'Analyze', showOnly: [], description: ''},
		{type: 'sectionTable', id: 'eggs', title: 'By Egg Type', showOnly: [], description: 'Lists all eggs and counts of pet & mounts.'},
		{type: 'sectionTable', id: 'potions', title: 'By Potion Type', showOnly: [], description: 'Lists all potions and counts of pet & mounts.'},
		{type: 'sectionTable', id: 'actionLog', title: 'Activity Log', showOnly: [], description: 'Lists all actions and responses from Bulk Feeding the pets through the tools.'}
	
]

//named for searching
//Not sure this is bad as mixing constants with definitions... but hey :)
var sectionTables =	{}
sectionTables['pets'] = {
	type: 'pets',
	dataSet: [], 
	dataSetHeader: ['', 'Key', 'Name',  'Type', 'Potion Name', 'Egg Name', 'Can Hatch?', 'Has Pet?', 'Has Mount?',  'Feed Bar', 'Ideal Food Avail'], 
	dataTable: ['imgTag', 'key', 'text', 'typePretty', 'potionPretty', 'eggPretty', 'canHatch', 'pet',  'mount', 'feedValue', 'foodAvail'],
	babyBear: {show: [2,7,8,9,10], orderBy: [[2, 'asc']]},
	mamaBear: {show: [2,3,6,7,8,9,10], orderBy: [[2, 'asc']]},
	papaBear: {show: [0,2,3,4,5,6,7,8,9,10], orderBy: [[2, 'asc']]},
	extraColumnDefs: [{'className': 'dt-center', 'targets': [6,7,8,9]},{'className': 'dt-right', 'targets': [10]}],
	subTitle: function (){
		var html = selectionHeadingMultiSelect()
		return html 		
	},
	petKeyIndex: 1,
	petNameIndex: 2,
	extraButton: function(){
		var returnButton = []
		var manualFeedPetButton = []
		var singleButton = []
		$.each(food, function(index, obj){
			if (obj.total > 0 ) {
				singleButton = {
					text: obj.text, // + ' (' + obj.total + ')', //Can't update totals on refresh so hiding.
					action: function ( e, dt, node, config ) {
						var rowData = sectionTables['pets'].table.rows( { selected: true } ).data().toArray();
						var petKeyIndex = sectionTables['pets'].petKeyIndex;
						var petNameIndex = sectionTables['pets'].petNameIndex;
						manualFeedPet(rowData, petKeyIndex, petNameIndex, index)	
					}
				}	
				manualFeedPetButton.push(singleButton)
			}
			
		});
		
		returnButton = []
		returnButton.push({
			text: 'Bulk Hatch',
			action: function ( e, dt, node, config ) {
					var rowData = sectionTables['pets'].table.rows( { selected: true } ).data().toArray();
					var petKeyIndex = sectionTables['pets'].petKeyIndex;
					var petNameIndex = sectionTables['pets'].petNameIndex;
					postHatchPet(rowData, petKeyIndex, petNameIndex, false, -1)	
				},
			className: 'hatchPetButton'		
		})
		
		if (manualFeedPetButton.length > 0) {
			returnButton.push({
				extend: 'collection',
				text: 'Manual Feed',
				buttons: manualFeedPetButton,
				autoClose: true,
				className: 'manualFeedPetButton'		
			})
		}			
					
					
		returnButton.push({
			text: 'Bulk Feed',
			action: function ( e, dt, node, config ) {
					var rowData = sectionTables['pets'].table.rows( { selected: true } ).data().toArray();
					var petKeyIndex = sectionTables['pets'].petKeyIndex;
					var petNameIndex = sectionTables['pets'].petNameIndex;
					postFeedPet(rowData, petKeyIndex, petNameIndex, false, -1, -1)	
				},
			className: 'feedPetButton'		
		})
			
		return returnButton
	}
}

sectionTables['triadBingoRequirement'] = {
	type: 'triadBingoRequirement',
	dataSet: [], 
	dataSetHeader: ['', 'Category', 'Name', 'Require', 'Have', 'Missing'], 
	dataTable: ['imgTag', 'category', 'text', 'require', 'have', 'missing'],
	babyBear: {show: [1,4], orderBy: [[1, 'asc'],[2, 'asc']]},
	mamaBear: {show: [1,3,4], orderBy: [[1, 'asc'],[2, 'asc']]},
	papaBear: {show: ['all'], orderBy: [[1, 'asc'],[2, 'asc']]},
	extraColumnDefs: [{'className': 'dt-right', 'targets': [3,4,5]}],
	subTitle: function (){
		var html = ''
		if (canTriadBingo) {
			html += '<p>You have all items required! Hatch and feed all for Triad Bingo?</p>'
			html += '<p><input class="div-triadBingo" id="triadBingo" type="submit" value="Yes! Hatch and Feed all for Triad Bingo" /></p>'
		} else if (sectionTables['triadBingoRequirement'].dataSet.length > 0) {
			html += '<p>Listed below are the items missing to complete Triad Bingo. Keep collecting! Once collected return here to bulk hatch and feed.</p>'
			html += '<p><input class="div-triadBingo" id="triadBingo" type="submit" value="I cannot wait! Hatch and feed my Standard (Gen 1) pets as much as possible." /></p>'
		} else {
			html += '<p>You have Triad Bingo!</p>'
			html += '<p><input class="div-releaseTriadBingo" id="releaseTriadBingo" type="submit" value="Again! Again! Release all my Standard (Gen 1) pets and mounts and go for Triad Bingo Again!" /></p>'
		}

		return html 		
	}
}

sectionTables['sellItems'] = {
	type: 'sellItems',
	dataSet: [], 
	dataSetHeader: ['', 'Key', 'Category', 'Name',  'Type', 'Gold Value', 'Total'], 
	dataTable: ['imgTag', 'key', 'category', 'text', 'type', 'value', 'total'],
	babyBear: {show: [2,3,6], orderBy: [[2, 'asc'],[3, 'asc']]},
	mamaBear: {show: [2,3,5,6], orderBy: [[2, 'asc'],[3, 'asc']]},
	papaBear: {show: [0,2,3,4,5,6], orderBy: [[2, 'asc'],[3, 'asc']]},
	extraColumnDefs: [{'className': 'dt-right', 'targets': [5,6]}],
	subTitle: function (){
		var html = selectionHeadingMultiSelect()
		return html 		
	},
	itemKeyIndex: 1,
	itemCatIndex: 2,
	itemNameIndex: 3,
	extraButton: function(){
		var returnButton = []
		var sellButton = []
		var singleButton = []
		var arrayOfButton = [{text: 'Sell X Times', sellAction: 5},{text: 'Sell Till X Left', sellAction: -5},{text: 'Sell All', sellAction: 0}]
		
		$.each(arrayOfButton, function(index, obj){
			singleButton = {
				text: obj.text,
				action: function ( e, dt, node, config ) {
					var rowData = sectionTables['sellItems'].table.rows( { selected: true } ).data().toArray();
					var itemKeyIndex = sectionTables['sellItems'].itemKeyIndex;
					var itemCatIndex = sectionTables['sellItems'].itemCatIndex;
					var itemNameIndex = sectionTables['sellItems'].itemNameIndex;
					postSellItem(rowData, itemKeyIndex, itemCatIndex, itemNameIndex, obj.sellAction, false, -1)	
				},
				className: 'sellButton'
			}
			sellButton.push(singleButton)
		});
		
		returnButton = []
/*		returnButton.push({
				extend: 'collection',
				text: 'Sell',
				buttons: sellButton,
				autoClose: true,
				className: 'sellButton'		
		})			
*/	//Users didn't realise there was multiple options				
		returnButton = sellButton
		return returnButton
	}
}

sectionTables['eggs'] = {
	type: 'eggs',
	dataSet: [], 
	dataSetHeader: ['', 'Key', 'Name', 'Type', 'Egg Count', 'Not Hatched',  'Pets To Feed', 'Mounts', 'ReGen Pets', 'Triad Bingo?', 'HatchSpaces', 'Pet Feed List'], 
	dataTable: ['imgTag', 'key', 'text', 'feedStats.type', 'total', 'feedStats.notHatchCount', 'feedStats.petFeedCount', 'feedStats.mountCount', 'feedStats.petNoFeedCount', 'feedStats.allPetsFed', 'feedStats.hatchSpaceCount', 'feedStats.petFeedList'],
	babyBear: {show: [2,4], orderBy: [[2, 'asc']]},
	mamaBear: {show: [2,3,4,10], orderBy: [[2, 'asc']]},
	papaBear: {show: [0,2,3,4,5,6,7,8,9,10,11], orderBy: [[2, 'asc']]},
	extraColumnDefs: [{'className': 'dt-center', 'targets': [9]}, {'className': 'dt-right', 'targets': [4,5,6,7,8,10]}],
	subTitle: function (){
		var html = ''
		html += 'Magic Potion Pets are not included in the counts. Please see <span class="showHideToggle" data-target="potionsSection" data-closemainsections="true">Analyze By Potion Section</span> for counts of these pets.'
		return html 		
	}
}


sectionTables['potions'] = {
	type: 'potions',
	dataSet: [], 
	dataSetHeader: ['', 'Key', 'Name', 'Magic Potion?', 'Wacky?', 'Potion Count', 'Food Available', 'Not Hatched', 'Pets To Feed', 'Mounts', 'ReGen Pets'], 
	dataTable: ['imgTag', 'key', 'text', 'premium', 'wacky', 'total', 'foodAvail', 'feedStats.notHatchCount', 'feedStats.petFeedCount', 'feedStats.mountCount', 'feedStats.petNoFeedCount'],
	babyBear: {show: [2,5], orderBy: [[2, 'asc']]},
	mamaBear: {show: [0,2,3,5], orderBy: [[2, 'asc']]},
	papaBear: {show: [0,2,3,4,5,6,7,8,9,10], orderBy: [[2, 'asc']]},
	extraColumnDefs: [{'className': 'dt-center', 'targets': [3,4]}, {'className': 'dt-right', 'targets': [5,6,7,8,9,10]}],
	subTitle: function (){
		var html = ''
		return html 		
	}
}

sectionTables['actionLog'] = {
	type: 'actionLog',
	dataSet: [], 
	dataSetHeader: ['Date', 'Epoch', 'ActionId',  'Response?', 'Message'], 
	dataTable: ['creation.shortDate', 'epoch', 'actionLogId', 'response', 'message'],
	babyBear: {show: [0,3], orderBy: [[1, 'desc'],[3, 'asc']]},
	mamaBear: {show: [0,2,3], orderBy: [[1, 'desc'],[3, 'asc']]},
	papaBear: {show: ['all'], orderBy: [[1, 'desc'],[3, 'asc']]},
	extraColumnDefs: [{'className': 'dt-center', 'targets': [0,3]},{'className': 'dt-right', 'targets': [1]}],
	subTitle: function (){
		var html = 'Log will clear once html page is refreshed or "Fetch Pet Data" Button in show documentation/options again area.'
		return html 		
	}
}

function selectionHeadingMultiSelect() {
	var html = ''
	html += '<p>To select records in bulk select the first and then hold down the shift key to select the last record. To select multiples hold down the ctrl key while selecting.</p>'
	return html
}

//export options	
var exportOptions = [
	{id: 'babyBear', shortDesc: 'Baby Bear', longDesc: 'Displays & exports short table format'},
	{id: 'mamaBear', shortDesc: 'Mama Bear', longDesc: 'Displays & exports medium table format'},
	{id: 'papaBear', shortDesc: 'Papa Bear', longDesc: 'Displays & exports max table format (most)'}
];
var exportFormats = [
	{id: 0, shortDesc: 'Warm Porridge', longDesc: 'Displays & exports with Emoji & Text converted but HTML removed', convertMarkup: true, removeHtml: true, convertLineBreaks: false},
	{id: 1, shortDesc: 'Hot Porridge', longDesc: 'Displays & exports in exact Habitica HTML format', convertMarkup: true, removeHtml: false, convertLineBreaks: false},
	{id: 2, shortDesc: 'Cold Porridge', longDesc: 'Displays & exports in raw format', convertMarkup: false, removeHtml: false, convertLineBreaks: true}
];


				 
					
//////////////////////////////////////////////////////////////////////
////   Global Connection Variables      //////////////////////////////
//////////////////////////////////////////////////////////////////////
var warningMessage				= 	'PLEASE ENSURE YOUR MESSAGE IS:\n' +
									'\n\u2022 is respectful, supportive and courteous;' + 
									'\n\u2022 is not spam, including unwanted advertisements of products, social media accounts, etc;' +
									'\n\u2022 is not begging for a gift of gems or a subscription' +
									'\n\u2022 meets all requirements of the Community Guidelines of Habitica (https://habitica.com/static/community-guidelines). ' +
									'\n\u2022 meets all requirements of the Term of Service of Habitica (https://habitica.com/static/terms). ' +
									'\n' +
									'\nFailure to do so can lead to minor consequences (like warnings) to severe consequences including account bans & deletions.' +
									'\n' +
									'\nIf you have any concerns, please email Lemoness (leslie@habitica.com) for clarification.'

var serverName					= 'Habitica'; // used in "loading" message
var serverUrl					= 'https://habitica.com/api/v3';
var serverPathContent			= '/content?language=en';
var serverPathUser				= '/user';
var serverPathFeedPet			= '/user/feed'
var serverPathHatchPet			= '/user/hatch'
var serverPathSellItem			= '/user/sell'
var serverReleaseAllPets		= '/user/release-both'
var imageURL					= 'https://habitica-assets.s3.amazonaws.com/mobileApp/images/' 
var imageShopPrefix             =  'shop_'
var imageStableFood             =  'Pet_Food_'
var imageStableEgg	            =  'Pet_Egg_'
var imageStablePotion           =  'Pet_HatchingPotion_'
var imageStablePet		        =  'Pet-'
var imageFileSuffix				= '.png'

var baseTimeoutPeriod			= 2300 // 2.3 seconds = 58 minutes completing Triad Bingo
var baseTimeoutPeriodLong		= 30000 // 30 seconds
var clientId					= 'bc10ec41-4213-4482-bbb8-558e3c3ea8d5-BulkFeed'
var userId						= '';
var apiToken					= '';
var showImage					= false;
var exportOption 			 	= 'papaBear';
var exportFormat			 	= 1;
var debug						= false;
var debugShowObject				= false;

if (debug || debugShowObject) serverName = '*** TURN DEBUG OFF! *** - ' + serverName
if (debug) console.log('debug 1');

var sectionOpen = ''; // holds the ID attribute of a section of the page;
                      // persists through re-fetch of data so we can
                      // reopen that section when the new data arrives
var tellMe = '<a href="https://github.com/cTheDragons">tell me</a>';

var neverDate = '1900-01-01'

//////////////////////////////////////////////////////////////////////
////   allow Show/Hide Toggling to work    ///////////////////////////
//////////////////////////////////////////////////////////////////////
enableShowHideToggling(); // needed here to enable Version Changes link
var openRelatedSections = function(){} // redefined later when user data exists
function enableShowHideToggling() {
if (debug) console.log('debug enableShowHideToggling');

	//Populate Selector
//	var htmlExport =  getExportOptionsHtml()
//	var htmlDesc =  getExportDescHtml()
	var htmlSection = getSectionDescHtml()
	
//	$('#exportOptionSelector').html(htmlExport)
//	$('#exportOptionDesc').html(htmlDesc)
	$('#sectionDesc').html(htmlSection)

    // $('.showHideToggle').click(function(event)
	$('body').unbind('click')
    $('body').on('click', '.showHideToggle', function(event){
        var target = $(this).data("target");
        var wantToShow = (! $('#' + target).is(':visible')
                       || $(this).data("forceopen"));
            // wantToShow is false if the target is already open
            // (i.e., the user wants to close it)
            // unless the toggle's attributes force it to always be
            // opened (e.g., a link from the dashboard)
        var linktext = $(this).data("linktext") || false;
        if ($(this).data("closemainsections")) {
            $('#MAIN > *').hide();
        }
        if (wantToShow) {
            sectionOpen = target;
            $('#' + target).show();
            if (linktext) {
                $(this).text('hide ' + linktext);
            }
            openRelatedSections();
        }
        else {
            $('#' + target).hide();
            if (linktext) {
                $(this).text('show ' + linktext);
            }
            if ($(this).data("scrolltotop")) {
                window.scrollTo(0, 0);
            }
        }
        var toggleTarget = $(this).data("resettoggletext") || false;
        if (toggleTarget) {
            $('#' + toggleTarget).text('show '
                        + $('#' + toggleTarget).data("linktext"));
        }
    });
    $('body').on('click', '.mainSectionClose', function(event){
        $('#MAIN > *').hide();
        window.scrollTo(0, 0);
    });
	$('body').on('click', '.div-triadBingo', function(event){
		$(this).attr('disabled','disabled');
		triadBingoHatchFeedPet()
	});
	$('body').on('click', '.div-releaseTriadBingo', function(event){
		$(this).attr('disabled','disabled');
		postReleaseTriadBingo()
	});	
	
	function getExportOptionsHtml()
	{
		var html = '';
		
		html +=  '<label for="exportOption"><span>Column Option</span>'
		html +=  '<select name="exportOption" id="exportOption">';
		if (debugShowObject) console.log(exportOptions);
		$.each(exportOptions, function(index, obj){
			html += '<option value="' + obj.id + '"'
			if (obj.id == exportOption) html += ' selected '
			html += '>' + obj.shortDesc + '</option>';
		});
		html += '</select></label>'

		html +=  '<label for="exportFormat"><span>Text Format</span>'
		html +=  '<select name="exportFormat" id="exportFormat">';
		if (debugShowObject) console.log(exportOptions);
		$.each(exportFormats, function(index, obj){
			html += '<option value="' + obj.id + '"'
			if (obj.id == exportFormat) html += ' selected '
			html += '>' + obj.shortDesc + '</option>';
		});
		html += '</select></label>'

		
		return html
	}
	
	function getExportDescHtml()
	{
		var html = '';
		
		html +=  '<p class="highlight">Column Options Description:</p>'
		html +=  '<ul>';
		$.each(exportOptions, function(index, obj){
			html += '<li><span class="lowlight">' + obj.shortDesc + '</span>: ' + obj.longDesc + '</li>';
		});
		html += '</ul>'

		html +=  '<p class="highlight">Text Format Description:</p>'
		html +=  '<ul>';
		$.each(exportFormats, function(index, obj){
			html += '<li><span class="lowlight">' + obj.shortDesc + '</span>: ' + obj.longDesc + '</li>';
		});
		html += '</ul>'
		
		return html
	}
	
	function getSectionDescHtml()
	{
		var html = '';
		
		$.each(sectionsToDisplay, function(index, obj){
			if (obj.type != 'heading') html += '<li><span class="subheading">' + obj.title + '</span>: ' + obj.description + '</li>';
		});
		
		return html
	}
}


//////////////////////////////////////////////////////////////////////
////   Get UUID from URL      ////////////////////////////////////////
//////////////////////////////////////////////////////////////////////
var url_vars = getUrlVars();
if (url_vars.hasOwnProperty("userId")) {
	$("#userId").val(url_vars.userId);
} else if (url_vars.hasOwnProperty("userid")) {
	$("#userId").val(url_vars.uuid);
} else if (url_vars.hasOwnProperty("uuid")) {
	$("#userId").val(url_vars.uuid);
}

if (url_vars.hasOwnProperty("show_image")) {
	if ((url_vars.show_image == "checked") || (url_vars.show_image == "true"))
		$("#showImage").prop("checked", true);
	else {
		$("#showImage").prop("checked", false);
	} 
}

if (url_vars.hasOwnProperty("showimage")) {
	if ((url_vars.showimage == "checked") || (url_vars.showimage == "true"))
		$("#showImage").prop("checked", true);
	else {
		$("#showImage").prop("checked", false);
	} 
}


if (url_vars.hasOwnProperty("showImage")) {
	if ((url_vars.showImage == "checked") || (url_vars.showImage == "true"))
		$("#showImage").prop("checked", true);
	else {
		$("#showImage").prop("checked", false);
	} 
}


function getUrlVars() {
    // Function found at http://stackoverflow.com/questions/4656843/jquery-get-querystring-from-url#answer-4656873
    var vars = [], hash;
    var hashes = window.location.href.slice(window.location.href.indexOf('?') + 1).split('&');
    for(var i = 0; i < hashes.length; i++)
    {
        hash = hashes[i].split('=');
        vars.push(hash[0]);
        vars[hash[0]] = hash[1];
    }
    return vars;
}


//////////////////////////////////////////////////////////////////////
////   Login events      /////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////
$('#userApiDetailsForm').unbind('click')
$('#userApiDetailsForm').on('click', '.div-fetchData', function(event){
if (debug) console.log('debug #userApiDetailsForm (Fetch Data)');
	/* The user manually submitted the API connection form. */
    userId   = $('#userId').val();
    apiToken = $('#apiToken').val();
	showImage = $('#showImage')[0].checked;
//	exportOption = $('#exportOption').val()
//   exportFormat = $('#exportFormat').val()
	actionLog = []
	fetchData();
	
	$('.showHideToggle').data('target', 'petsSection')
//	$('.showHideToggle').data('closemainsections', 'true')
	$('.showHideToggle').trigger('click');
	$('.showHideToggle').data('target', 'petsSection')
	$('.showHideToggle').removeData('target')
	
}); 



//////////////////////////////////////////////////////////////////////
////   Data Fetch Functions   //////////////////////////////
//////////////////////////////////////////////////////////////////////
function fetchData() {
    if (debug) console.log('debug fetchData start');
    $('#loading #serverName').text(serverName);
    $('#loading .good').show();
    $('#loading .bad' ).hide();
	$('#loading .error' ).hide();
			
    var ajaxRunningCount = 2; // drops to 0 when all calls have succeeded
	
    // fetch the user's own content (guilds, parties):
	$('#loading #statusFetch').text('Asking for User Data');
    $.ajax({
        url: serverUrl + serverPathUser,
        type: 'GET',
        dataType: 'json',
        cache: false,
        beforeSend: function(xhr){
                xhr.setRequestHeader('x-client', clientId);
				xhr.setRequestHeader('x-api-user', userId);
                xhr.setRequestHeader('x-api-key',  apiToken);
            },
        success: fetchUserSuccess,
        error: fetchFailure
    });

    // fetch the site-wide content (gear names and stats, etc):
	$('#loading #statusFetch').text('Asking for Generic Content');
    $.ajax({
        url: serverUrl + serverPathContent,
        type: 'GET',
        dataType: 'json',
        cache: true,
        success: fetchContentSuccess,
        error: fetchFailure
    });
	

	function fetchFailure() {
        if (debug) console.log('debug fetchFailure start');
        $('#loading .good').hide();
        $('#loading .bad' ).show();
        $('#documentationAndForm').show(); // in case user has done a re-fetch
        $('#documentationAndFormClose').hide();
        if (debug) console.log('debug fetchFailure end');
    }
	function fetchUserSuccess(data) {
        if (debug) console.log('debug parseData User success start');
		$('#loading #statusFetch').text('Fetching User Data');
        user = data.data;
		
		userIsAdmin = false;
		if (user.contributor != undefined) {
			if (user.contributor.admin) userIsAdmin = true
		}

		if (debugShowObject) console.log(user);
        ajaxRunningCount--;
        if (ajaxRunningCount === 0) { // all ajax calls have finished
            parseData();
        }
    }
	
	function fetchContentSuccess(data) {
        if (debug) console.log('debug parseData Content success start');
		$('#loading #statusFetch').text('Fetching Generic Content');
        content = data.data;
		if (debugShowObject) console.log(content);
        ajaxRunningCount--;
        if (ajaxRunningCount === 0) { // all ajax calls have finished
            parseData();
        }
    }
}

//////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////
////  Post functions 				     //////////////////////////////
//////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////
// All post functions are implemented serial as they are unreliable when performed in parallel.



//////////////////////////////////////////////////////////////////////
////  Post Hatch Pet				      //////////////////////////////
//////////////////////////////////////////////////////////////////////
function postHatchPet(rowData, petKeyIndex, petNameIndex, noPromptToFeed, multiStep) {
	if (debug) console.log('debug postHatchPet start');
	var urlToPost = ''	
	var hatchPetList = ''
	var nothatchPetList = ''
	var eggKey = ''
	var potionKey = ''
	var index = 0 
	var loopList = []
	var actionLogId = 'HatchPet'
	var proceed = noPromptToFeed
	
	if (rowData.length == 0){
		if (debug) console.log('debug no users to remove');
		alert('No row selected.\nPlease select a row before trying again.');
		return;
	
	} else {
		if (debugShowObject) console.log( rowData );
		
		//get UniqueRows
		for(var i = 0; i < rowData.length; i++) {
			//Check if can hatch egg first
			if  ((noPromptToFeed) || (pets[rowData[i][petKeyIndex]].canHatch == 'true')) {
				notInLoop = true
				
				for(var j = 0; j < loopList.length; j++) {
					if (rowData[i][petKeyIndex] == loopList[j][petKeyIndex]) {
						notInLoop = false
						break;
					}
						
				}
				
				if (notInLoop) {
					loopList.push(rowData[i])
				}
			} else {
				nothatchPetList += '\n\u2022  ' + rowData[i][petNameIndex]
			}
		}
		
		if (nothatchPetList != '') {
			if (loopList.length == 0 ) {
				alert('The following pets cannot be hatch: ' + nothatchPetList + '\n\nNo other Pets can be hatch.\n\nAction cancelled')
				return;
			
			}
			if (confirm('The following pets cannot be hatch: ' + nothatchPetList + '\n\nCancel hatching other pets?')){
				alert('Action cancelled')
				return;
			}
		}

		for(var i = 0; i < loopList.length; i++)
		{
			hatchPetList += '\n\u2022  ' + loopList[i][petNameIndex]
		}
		
		if (noPromptToFeed == false) proceed = (confirm('Are you sure you wish to hatch the following pets?' + hatchPetList + '\n\n'))
		if (proceed){
			hatchPetList = ''
			postNextHatchPet()
		} else {
			alert('Action cancelled')
			return;
		}

	}
	
	//This is done like this as receive ERR_INCOMPLETE_CHUNKED_ENCODING
	function postNextHatchPet(){
		$('#posting .good').show();
		
		obj = loopList[index]
			
		
		//Get Keys
		eggKey = pets[obj[petKeyIndex]].egg 
		potionKey = pets[obj[petKeyIndex]].potion 
		
		if (pets[obj[petKeyIndex]].pet == false){ //test for triad Bingo
			if ((eggs[eggKey].total > 0) && (potions[potionKey].total > 0)) {
				eggs[eggKey].total-- //remove one item away
				potions[potionKey].total-- //remove one item away
				
				urlToPost = serverUrl + serverPathHatchPet + '/' + eggKey + '/' + potionKey
				$('#posting #statusPost').text('Hatching ' + obj[petNameIndex] );
				createActionLog(actionLogId, false, 'Hatching ' + obj[petNameIndex] );
				if (debugShowObject) console.log(urlToPost);
				$.ajax({
					url: urlToPost,
					type: 'POST',
					dataType: 'json',
					cache: false,
					beforeSend: function(xhr){
							xhr.setRequestHeader('x-client', clientId);
							xhr.setRequestHeader('x-api-user', userId);
							xhr.setRequestHeader('x-api-key',  apiToken);
						},
					success: postHatchPetSuccess,
					error: postHatchPetFailure
				});		
			} else {
				//No Eggs To hatch
				createActionLog(actionLogId, false, 'Not enough eggs or potions to hatch ' + obj[petNameIndex] );
				index++
				postHatchPetCompleted()
			}
		} else {
			//no action - silently fall over
			index++
			postHatchPetCompleted()			
		}
	}
		

	
	function postHatchPetFailure(data){
		if (debug) console.log('debug postHatchPetFailure start');
		if (debugShowObject) console.log(data);
		var errData = data;
		var errItem = ''
		var errMessage = ''
		
		if (errData.responseJSON != undefined) {
			errItem = errData.responseJSON.error
			if (errData.responseJSON.message != undefined ) errMessage = errData.responseJSON.message
		} else {
			if (errData.message != undefined ) errMessage = errData.responseText
			if (errData.error != undefined ) errItem = errData.statusText
		}
		
		createActionLog(actionLogId, true, errItem + '&nbsp&nbsp&nbsp&nbsp ' + errMessage)
		alert('ERROR WITH  ' +  obj[petNameIndex] + '\n\n' + errItem + '\n' + errMessage + '\n\nPlease refetch your data and try again.');	
		index++
		
		postHatchPetCompleted()
	}


	function postHatchPetSuccess(data){
		if (debug) console.log('debug postHatchPetSucess start');
		$('#posting #statusPost').text('Successfully Hatched ' + obj[petNameIndex] + '(' + data.message + ')' );
		createActionLog(actionLogId, true, data.message);
		if (debugShowObject) console.log(data);
		pets[obj[petKeyIndex]].feedValue = 1 //This is set for multistep to state the pet can be feed.

		index++
		hatchPetList += '\n\u2022  ' + obj[petNameIndex]  	
		postHatchPetCompleted()
		
	}
	
	function postHatchPetCompleted() {
		if (index === loopList.length){
			$('#posting .good').hide();
			if (debugShowObject) console.log(hatchPetList);
			if (multiStep >= 0) {
				multiStepArray[multiStep].result = 'The following pets have become mounts:' + hatchPetList
				multiStepNextAction()
			} else {	
				alert('The following pets have been hatched:' + hatchPetList + '\n\nYour data will now be refreshed')
				fetchData() 
			}
		} else {
			setTimeout(function(){
				postNextHatchPet()
			}, baseTimeoutPeriod)
		}		
	
	}
}

//////////////////////////////////////////////////////////////////////
////  Post Feed Pet				      //////////////////////////////
//////////////////////////////////////////////////////////////////////
function postFeedPet(rowData, petKeyIndex, petNameIndex, noPromptToFeed, foodKeyIndex, multiStep) {
	if (debug) console.log('debug postFeedPet start');
	var urlToPost = ''	
	var feedPetList = ''
	var notFeedPetList = ''
	var index = 0
	var foodKey 
	var loopList = []
	var actionLogId = 'FeedPet'
	var proceed = noPromptToFeed
	
	if (rowData.length == 0){
		if (debug) console.log('debug no users to remove');
		alert('No row selected.\nPlease select a row before trying again.');
		return;
	
	} else {
		if (debugShowObject) console.log( rowData );
		
		//get UniqueRows
		for(var i = 0; i < rowData.length; i++) {
			//Check if can feed pet first
			if  ((noPromptToFeed) || ((pets[rowData[i][petKeyIndex]].pet == true) && ((pets[rowData[i][petKeyIndex]].foodAvail > 0 || foodKeyIndex != undefined ))) && (pets[rowData[i][petKeyIndex]].type != 'wacky') ) {
				notInLoop = true
				
				for(var j = 0; j < loopList.length; j++) {
					if (rowData[i][petKeyIndex] == loopList[j][petKeyIndex]) {
						notInLoop = false
						break;
					}
						
				}
				
				if (notInLoop) {
					loopList.push(rowData[i])
				}
			} else {
				notFeedPetList += '\n\u2022  ' + rowData[i][petNameIndex]
			}
		}
		
		if (notFeedPetList != '') {
			if (loopList.length == 0 ) {
				alert('The following pets cannot be feed: ' + notFeedPetList + '\n\nNo other Pets can be feed.\n\nAction cancelled')
				return;
			
			}
			if (confirm('The following pets cannot be feed: ' + notFeedPetList + '\n\nCancel feeding other pets?')){
				alert('Action cancelled')
				return;
			}
		}

		for(var i = 0; i < loopList.length; i++)
		{
			feedPetList += '\n\u2022  ' + loopList[i][petNameIndex]
		}
		
		if (noPromptToFeed == false) proceed = (confirm('Are you sure you wish to feed the following pets?' + feedPetList + '\n\n')) 
		if (proceed){
				feedPetList = ''
				postNextFeedPet()
		} else {
			alert('Action cancelled')
			return;
		}

	}
	
	//This is done like this as receive ERR_INCOMPLETE_CHUNKED_ENCODING
	function postNextFeedPet(){
		$('#posting .good').show();
		
		obj = loopList[index]
		
		//Find Food to use
		foodKey = ''
		if ((pets[obj[petKeyIndex]].feedValue > 0) ) { 
			if (foodKeyIndex < 0) {
				if (pets[obj[petKeyIndex]].type == 'premium') {
					var maxFood = 0
					$.each(potions, function(index2, obj2){
						if (obj2.foodAvail > maxFood ) {
							maxFood = obj2.foodAvail
							$.each(food, function(index3, obj3){
								if ((obj3.total > 0 ) && (obj3.target == index2)) {
									foodKey = index3
								}						
							});
						}						
					});
				} else {
					$.each(food, function(index2, obj2){
						if (obj2.total > 0 ) {
							if (pets[obj[petKeyIndex]].potion == obj2.target) foodKey = index2
						}
						
					});
				}
			} else {
				if (food[obj[foodKeyIndex]] != undefined) {
					if (food[obj[foodKeyIndex]].total > 0 ) {
						foodKey = obj[foodKeyIndex]
					}
				}
			}

		
			if (foodKey != '') {
				food[foodKey].total-- //remove one item away
				potions[food[foodKey].target].foodAvail-- //for magic potion pets
		
				urlToPost = serverUrl + serverPathFeedPet + '/' + obj[petKeyIndex] + '/' + foodKey
				$('#posting #statusPost').text('Feeding ' + obj[petNameIndex] + ' with ' + food[foodKey].text );
				createActionLog(actionLogId, false, 'Feeding ' + obj[petNameIndex] + ' with ' + food[foodKey].text);
				if (debugShowObject) console.log(urlToPost);
				$.ajax({
					url: urlToPost,
					type: 'POST',
					dataType: 'json',
					cache: false,
					beforeSend: function(xhr){
							xhr.setRequestHeader('x-client', clientId);
							xhr.setRequestHeader('x-api-user', userId);
							xhr.setRequestHeader('x-api-key',  apiToken);
						},
					success: postFeedPetSuccess,
					error: postFeedPetFailure
				});		
			} else {
				//No Food To Feed
				createActionLog(actionLogId, false, 'Not enough food to feed ' + obj[petNameIndex] );
				index++
				postFeedPetCompleted()
			}
		} else {
				//No Pet To Feed
				createActionLog(actionLogId, false, 'Cannot feed pet ' + obj[petNameIndex] + ' as it is not hatched.' );
				index++
				postFeedPetCompleted()
		}
	}
		

	
	function postFeedPetFailure(data){
		if (debug) console.log('debug postFeedPetFailure start');
		if (debugShowObject) console.log(data);
		var errData = data;
		var errItem = ''
		var errMessage = ''
		
		if (errData.responseJSON != undefined) {
			errItem = errData.responseJSON.error
			if (errData.responseJSON.message != undefined ) errMessage = errData.responseJSON.message
		} else {
			if (errData.message != undefined ) errMessage = errData.responseText
			if (errData.error != undefined ) errItem = errData.statusText
		}
		
		createActionLog(actionLogId, true, errItem + '&nbsp&nbsp&nbsp&nbsp ' + errMessage)
		alert('ERROR WITH  ' +  obj[petNameIndex] + '\n\n' + errItem + '\n' + errMessage + '\n\nPlease refetch your data and try again.');	
		index++
		
		postFeedPetCompleted()
	}


	function postFeedPetSuccess(data){
		if (debug) console.log('debug postFeedPetSucess start');
		$('#posting #statusPost').text('Successfully Feed ' + obj[petNameIndex] + '(' + data.message + ')' );
		createActionLog(actionLogId, true, data.message);
		if (debugShowObject) console.log(data);
		
		
		if (data.data <= 0) {
			index++
			pets[obj[petKeyIndex]].pet = false //Set to false so pet can be feed again for triad.
			feedPetList += '\n\u2022  ' + obj[petNameIndex]  
		}	
		postFeedPetCompleted()
		
	}
	
	function postFeedPetCompleted() {
		if (index === loopList.length){
			$('#posting .good').hide();
			if (debugShowObject) console.log(feedPetList);
			if (multiStep >= 0) {
				multiStepArray[multiStep].result = 'The following pets have become mounts:' + feedPetList
				multiStepNextAction()
			} else {	
				alert('The following pets have become mounts:' + feedPetList + '\n\nYour data will now be refreshed')
				fetchData() 
			}
		} else {
			setTimeout(function(){
				postNextFeedPet()
			}, baseTimeoutPeriod)
		}		
	
	}
}



//////////////////////////////////////////////////////////////////////
////  Post Sell Items				      //////////////////////////////
//////////////////////////////////////////////////////////////////////
function postSellItem(rowData, itemKeyIndex, itemCatIndex, itemNameIndex, sellAction, noPromptToFeed, multiStep) {
	if (debug) console.log('debug postSellItem start');
	var urlToPost = ''	
	var sellItemList = ''
	var index = 0
	var foodKey 
	var loopList = []
	var sellAmount = Math.abs(sellAction)
	var sellAmountUrl = 1
	var proceed = noPromptToFeed

	var actionLogId = 'SellItem'
	var itemCode = {egg: 'eggs', potion: 'hatchingPotions', food: 'food'}
	
	
	if (rowData.length == 0){
		if (debug) console.log('debug no users to remove');
		alert('No row selected.\nPlease select a row before trying again.');
		return;
	
	} else {
		if (debugShowObject) console.log( rowData );
		
		//get UniqueRows
		for(var i = 0; i < rowData.length; i++) {
			//Check if can feed pet first
			notInLoop = true
			
			for(var j = 0; j < loopList.length; j++) {
				if (rowData[i][itemCatIndex] + '_' + rowData[i][itemKeyIndex] == loopList[j][itemCatIndex] + '_' + loopList[j][itemKeyIndex]) {
					notInLoop = false
					break;
				}
					
			}
			
			if (notInLoop) {
				loopList.push(rowData[i])
			}
		}
		
		for(var i = 0; i < loopList.length; i++)
		{
			sellItemList += '\n\u2022  ' + loopList[i][itemNameIndex] + ' ' + loopList[i][itemCatIndex]
		}
		
		if (noPromptToFeed == false) {
			if (sellAction == 0) {
				proceed = (confirm('Are you sure you wish to sell all of the following items?' + sellItemList + '\n\nThere is no undo!')) 
			} else if (sellAction > 0) {
				sellAmount = prompt('Please enter the amount to sell for all items listed:' + sellItemList, sellAmount)
			} else if (sellAction < 0) {
				sellAmount = prompt('For the following items listed:' + sellItemList + '\nsell until the following amount is left.', sellAmount)				
			}
		}

		if ((sellAmount != null) && (isNaN(sellAmount) == false)) proceed = true
		
		if (proceed){
				sellItemList = ''
				postNextSellItem()
		} else {
			alert('Action cancelled')
			return;
		}

	}
	
	//This is done like this as receive ERR_INCOMPLETE_CHUNKED_ENCODING
	function postNextSellItem(){
		$('#posting .good').show();
		
		obj = loopList[index]
				
		if (sellAction == 0) {
			sellAmountUrl = sellItems[obj[itemCatIndex] + '_' + obj[itemKeyIndex]].total
		} else if (sellAction > 0) {
			sellAmountUrl = sellAmount
		} else if (sellAction < 0) {
			sellAmountUrl = sellItems[obj[itemCatIndex] + '_' + obj[itemKeyIndex]].total - sellAmount
		}

		if (sellAmountUrl > 0) {
			urlToPost = serverUrl + serverPathSellItem + '/' + itemCode[obj[itemCatIndex]] + '/' + obj[itemKeyIndex] + '?amount=' + sellAmountUrl
			$('#posting #statusPost').text('Selling ' + sellAmountUrl + ' of ' + obj[itemNameIndex] + ' ' + obj[itemCatIndex] );
			createActionLog(actionLogId, false, 'Selling ' + sellAmountUrl + ' of ' + obj[itemNameIndex] + ' ' + obj[itemCatIndex]);
			if (debugShowObject) console.log(urlToPost);
			$.ajax({
				url: urlToPost,
				type: 'POST',
				dataType: 'json',
				cache: false,
				beforeSend: function(xhr){
						xhr.setRequestHeader('x-client', clientId);
						xhr.setRequestHeader('x-api-user', userId);
						xhr.setRequestHeader('x-api-key',  apiToken);
					},
				success: postSellItemSuccess,
				error: postSellItemFailure
			});		
		} else {
			//Not enough to sell
			createActionLog(actionLogId, false, 'Not enough to sell of ' + obj[itemNameIndex] + ' ' + obj[itemCatIndex] );
			index++
			postSellItemCompleted()			
		}
	}
		

	
	function postSellItemFailure(data){
		if (debug) console.log('debug postSellItemFailure start');
		if (debugShowObject) console.log(data);
		var errData = data;
		var errItem = ''
		var errMessage = ''
		
		if (errData.responseJSON != undefined) {
			errItem = errData.responseJSON.error
			if (errData.responseJSON.message != undefined ) errMessage = errData.responseJSON.message
		} else {
			if (errData.message != undefined ) errMessage = errData.responseText
			if (errData.error != undefined ) errItem = errData.statusText
		}
		
		createActionLog(actionLogId, true, errItem + '&nbsp&nbsp&nbsp&nbsp ' + errMessage);
		alert('ERROR WITH  ' +  obj[petNameIndex] + '\n\n' + errItem + '\n' + errMessage + '\n\nPlease refetch your data and try again.');	
		index++
		
		postSellItemCompleted()
	}


	function postSellItemSuccess(data){
		if (debug) console.log('debug postSellItemSucess start');
		$('#posting #statusPost').text('Successfully sold ' + sellAmountUrl + ' of ' + obj[itemNameIndex] + ' ' + obj[itemCatIndex] ) ; //+ '(' + data.message + ')' );
		createActionLog(actionLogId, true, 'Successfully sold ' + sellAmountUrl + ' of ' + obj[itemNameIndex] + ' ' + obj[itemCatIndex]);
		if (debugShowObject) console.log(data);
		
		index++
		sellItemList += '\n\u2022  ' + obj[itemNameIndex] + ' ' + obj[itemCatIndex]  

		postSellItemCompleted()
		
	}
	
	function postSellItemCompleted() {
		if (index === loopList.length){
			$('#posting .good').hide();
			if (debugShowObject) console.log(sellItemList);
			if (multiStep >= 0) {
				multiStepArray[multiStep].result = 'The following items have been sold:' + sellItemList
				multiStepNextAction()
			} else {	
				alert('The following items have been sold:' + sellItemList + '\n\nYour data will now be refreshed')
				fetchData() 
			}
		} else {
			setTimeout(function(){
				postNextSellItem()
			}, baseTimeoutPeriod)
		}		
	
	}
}


//////////////////////////////////////////////////////////////////////
////  Release Triad Bingo		   	    //////////////////////////////
//////////////////////////////////////////////////////////////////////
function postReleaseTriadBingo() {
	if (debug) console.log('debug postReleaseTriadBingo start');
	var actionLogId = 'ReleaseTriadBingo'
	
	if (confirm('Do you wish to release all your Standard (Gen 1) Pets and Mounts?')){
		postNextReleaseTriadBingo()
	} else {
		alert('Action cancelled')
		return;
	}
	

	//This is done like this as receive ERR_INCOMPLETE_CHUNKED_ENCODING
	function postNextReleaseTriadBingo(){
		$('#posting .good').show();
		
		urlToPost = serverUrl + serverReleaseAllPets
		if (debugShowObject) console.log(urlToPost);
		$('#posting #statusPost').text('Releasing all Standard (Gen 1) Pets & Mounts' );
		$.ajax({
			url: urlToPost,
			type: 'POST',
			contentType: 'application/json',
			dataType: 'json',
			cache: false,
			beforeSend: function(xhr){
					xhr.setRequestHeader('x-client', clientId);
					xhr.setRequestHeader('x-api-user', userId);
					xhr.setRequestHeader('x-api-key',  apiToken);					
				},
			success: postReleaseTriadBingoSuccess,
			error: postReleaseTriadBingoFailure
		});		
	}
		

	
	function postReleaseTriadBingoFailure(data){
		if (debug) console.log('debug postReleaseTriadBingoFailure start');
		if (debugShowObject) console.log(data);
		var errData = data;
		var errItem = ''
		var errMessage = ''
		
		if (errData.responseJSON != undefined) {
			errItem = errData.responseJSON.error
			if (errData.responseJSON.message != undefined ) errMessage = errData.responseJSON.message
		} else {
			if (errData.message != undefined ) errMessage = errData.responseText
			if (errData.error != undefined ) errItem = errData.statusText
		}
		
		createActionLog(actionLogId, true, errItem + '&nbsp&nbsp&nbsp&nbsp ' + errMessage)
		alert('ERROR WITH  ' +  obj[petNameIndex] + '\n\n' + errItem + '\n' + errMessage + '\n\nPlease refetch your data and try again.');	

		$('#posting .good').hide();		
		fetchData()
	}


	function postReleaseTriadBingoSuccess(data){
		if (debug) console.log('debug postReleaseTriadBingoSuccess start');
		if (debugShowObject) console.log(data);
		createActionLog(actionLogId, true, data.message);
		alert('All Standard (Gen 1) Pets & Mounts have been released.\n\nYour data will now be refreshed.')
		
		$('#posting .good').hide();
		fetchData() 
	}
	

}


//////////////////////////////////////////////////////////////////////
////  Manual Feed Pet				      //////////////////////////////
//////////////////////////////////////////////////////////////////////
function manualFeedPet(rowData, petKeyIndex, petNameIndex, foodKey) {
	if (debug) console.log('debug mannualFeedPet start');
	var feedPetList = ''
	var notFeedPetList = ''
	var index = 0
	var loopList = []

	
	if (rowData.length == 0){
		if (debug) console.log('debug no users to remove');
		alert('No row selected.\nPlease select a row before trying again.');
		return;
	
	} else {
		if (debugShowObject) console.log( rowData );
		
		//get UniqueRows
		for(var i = 0; i < rowData.length; i++) {
			//Check if can feed pet first
			if  ((pets[rowData[i][petKeyIndex]].pet == true) && (pets[rowData[i][petKeyIndex]].foodAvail > 0)) {
				notInLoop = true
				
				for(var j = 0; j < loopList.length; j++) {
					if (rowData[i][petKeyIndex] == loopList[j][petKeyIndex]) {
						notInLoop = false
						break;
					}
						
				}
				
				if (notInLoop) {
					loopList.push(rowData[i])
				}
			} else {
				notFeedPetList += '\n\u2022  ' + rowData[i][petNameIndex]
			}
		}
		
		if (notFeedPetList != '') {
			if (loopList.length == 0 ) {
				alert('The following pets cannot be feed: ' + notFeedPetList + '\n\nNo other Pets can be feed.\n\nAction cancelled')
				return;
			
			}
			if (confirm('The following pets cannot be feed: ' + notFeedPetList + '\n\nCancel feeding other pets?')){
				alert('Action cancelled')
				return;
			}
		}

		for(var i = 0; i < loopList.length; i++)
		{
			loopList[i].push(foodKey)
			feedPetList += '\n\u2022  ' + loopList[i][petNameIndex]
		}
		
		if (confirm('Are you sure you wish to feed the following pets with ' + food[foodKey].text + ' ?' + feedPetList + '\n\n')){
			postFeedPet(loopList, petKeyIndex, petNameIndex, true, (loopList[0].length-1), -1)
		} else {
			alert('Action cancelled')
			return;
		}

	}
}



//////////////////////////////////////////////////////////////////////
////  Triad Bingo			     		 //////////////////////////////
//////////////////////////////////////////////////////////////////////
function triadBingoHatchFeedPet() {
	var hatchFirst = []
	var feedSecond = []
	var hatchThird = []
	var arrayToAdd = []
	multiStepArray = []
	multiStep = 0
	
	var confirmMsg = 'Hatch eggs and feed pets to complete Triad Bingo?\n\nYou may want to get a drink, or do some tasks as this will take a while. (Estimated over 60 minutes).'
	if (canTriadBingo == false) confirmMsg = 'You do not have enough to complete Triad Bingo.\n\nHatch eggs and feed Standard (Gen 1) pets as much as possible?\n\nYou may want to get a drink, or do some tasks as this will take a while. (Can be over 20 minutes).' 
	
	if (confirm(confirmMsg)) {

	
		$.each(pets, function(index, obj){
			if (obj.type == 'drop') {
				arrayToAdd = [index, obj.text]
				if ((obj.pet == false) && (obj.mount == false)) {
					
					hatchFirst.push(arrayToAdd)
					feedSecond.push(arrayToAdd)
					hatchThird.push(arrayToAdd)
				
					
				} else if ((obj.pet == true) && (obj.mount == false)) {
					
					feedSecond.push(arrayToAdd)
					hatchThird.push(arrayToAdd)					
					
				} else if ((obj.pet == false) && (obj.mount == true)) {
				
					hatchThird.push(arrayToAdd)	
				
				}
			}
				
		});

		multiStepArray.push({action: 'postHatchPet', dataSet: hatchThird, petKeyIndex: 0, petNameIndex: 1, result: ''})
		if (feedSecond.length > 0) multiStepArray.push({action: 'postFeedPet', dataSet: feedSecond, petKeyIndex: 0, petNameIndex: 1, result: ''})	
		if (hatchFirst.length > 0) multiStepArray.push({action: 'postHatchPet', dataSet: hatchFirst, petKeyIndex: 0, petNameIndex: 1, result: ''})
		multiStep = multiStepArray.length 
		multiStepNextAction()
	} else {
		$('.div-triadBingo').removeAttr('disabled');
		$('.div-releaseTriadBingo').removeAttr('disabled');
		$('#refetch').removeAttr('disabled');
	}
}

//////////////////////////////////////////////////////////////////////
////  Multi-step (Supporting function for Triad & Others ////////////
//////////////////////////////////////////////////////////////////////
function multiStepNextAction() {
	multiStep--
	if (debug) console.log('MultiStep Next Action: ' + multiStep)
	if (debugShowObject) console.log(multiStepArray)

	if (multiStep >= 0) {
		if (multiStepArray[multiStep].action == 'postFeedPet') {
			postFeedPet(multiStepArray[multiStep].dataSet, multiStepArray[multiStep].petKeyIndex, multiStepArray[multiStep].petNameIndex, true, -1, multiStep)
		} else if (multiStepArray[multiStep].action == 'postHatchPet') {
			postHatchPet(multiStepArray[multiStep].dataSet, multiStepArray[multiStep].petKeyIndex, multiStepArray[multiStep].petNameIndex, true, multiStep)		
		} else if (multiStepArray[multiStep].action == 'postSellItem') {
			postSellItem(multiStepArray[multiStep].dataSet, multiStepArray[multiStep].itemKeyIndex, multiStepArray[multiStep].itemCatIndex, multiStepArray[multiStep].itemNameIndex, multiStepArray[multiStep].sellAction,  true, multiStep)		
		} else {
			alert('Fell off the steps! Call an Ambulance!')
		}
	} else {
		alert('All steps completed!\n\nSee Log for more detail after data is refreshed.')
		fetchData()
	}
}


//////////////////////////////////////////////////////////////////////
////  Create Action Log		     		 //////////////////////////////
//////////////////////////////////////////////////////////////////////
function createActionLog(actionLogId, response, message) {
	var addToArray = {}
	var epoch = moment().valueOf() 
	
	addToArray = {epoch: epoch, actionLogId: actionLogId, response: response, message: message} 
	actionLog.push(addToArray)

}



//////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////
////  Parse Data		      //////////////////////////////
//////////////////////////////////////////////////////////////////////	
//////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////
function parseData() {
	if (debug) console.log('debug parseData start');

	
    // variables for storing the content:
    var MAIN = {}; // each element defines the HTML for one section on the page
    var TOC  = {}; // each element defines one Table of Contents entry
    var DASHBOARD = {}; // each element defines the HTML for one dashboard tile

	var fetchtime = myDateConverter(new Date(), 'pretty');
	

    collateAndDisplayData(); //This is one function as memberActivty requires both Member and Guild data.

	userDataInHeader();

	
	//////////////////////////////////////////////////////////////////////
    ////   Display the HTML that the functions have created   ////////////
    //////////////////////////////////////////////////////////////////////
    $('#loading #statusFetch').text('') //All Done
	$('#loading .good').hide();
	$('#posting .good').hide(); // just to be sure
    $('#documentationAndFormClose').show();
    $('#documentationAndForm').hide();
	$('.div-triadBingo').removeAttr('disabled');
	$('#refetch').removeAttr('disabled');
	
	//formatAndDisplayDASHBOARD();
    formatAndDisplayTOC();
	
	
	if ($('#MAIN')[0].innerHTML.length > 1) {
		//Keep previous table settings
		refreshAndDisplayMAIN();
	} else {
		formatAndDisplayMAIN();
	}
	
	function formatAndDisplayDASHBOARD() {
		// Not required to be changed. Section controlled by Sections defined above.
		var html = '<ul>';
		var valueToDisplay = ''
		
		$.each(dashboardToDisplay, function(index, obj){
			if (obj.showOnly.length == 0 || (obj.showOnly.includes('party') == true && groupId == 'party') || (obj.showOnly.includes('leader') == true && ((userId == group.leader.id) || (userIsAdmin)))) {
				var data = obj;
				
				var classes = (data.hidden) ? 'hide' : '';
				html += '<li ';
				if (data.id) {
					// id is needed only if other code will change tile background
					html += 'id="' + data.id + '" ';
				}
				html += 'title="' + data.hoverText + '" ';
				if (data.target) {
					html += 'data-target="' + data.target +
							'" data-closemainsections="true" data-forceopen="true" ' +
							'class="showHideToggle ' + classes + '"';
				}
				
				valueToDisplay = eval(data.value)
				
				html += '><div class="' +
						data.status     + '"><div class="value">' +
						valueToDisplay      + '</div><div class="label">' +
						data.label      + '</div></div></li>';
			}
		});


		html += '</ul><div class="clear"></div>';
		if (debugShowObject) console.log(html);
		$('#DASHBOARD').html(html);
	}

	
	function formatAndDisplayTOC() {
		// Not required to be changed. Section controlled by Sections defined above.
		var keys = []
		var keyToAdd = ''
		
		$.each(sectionsToDisplay, function(index, obj){
			keyToAdd=''
			if (obj.showOnly.length == 0 || (obj.showOnly.includes('party') == true && groupId == 'party') || (obj.showOnly.includes('leader') == true && ((userId == group.leader.id) || (userIsAdmin)))) {
				if (obj.type != 'heading'){
					keyToAdd = obj.id
				} else {
					keyToAdd = 'HEADING'  
					if (obj.title != '') keyToAdd = keyToAdd + ' ' + obj.title
				}
				if (keyToAdd != '') keys.push(keyToAdd)
			}
		});
		if (debugShowObject) console.log(keys);
		
		var html = '';
		for (var i=0,ic=keys.length; i<ic; i++) {
			if (keys[i].match(/^HEADING/)) { // new section in Table of Contents
				var title = keys[i].replace(/^HEADING/, '');
				if (html) {
					html += '</ul></li>'; // close the previous section
				}
				html += '<li>' + title + (title ? ':' : '&nbsp;') + '<ul>';
			}
			else {
				var data = TOC[keys[i]];
				if (! data) {
					continue;
				}
				html += '<li class="showHideToggle" data-target="' +
						data['target'] + '" data-closemainsections="true">' +
						data['title']  + '</li>';
			}
		}
		html += '</ul></li></ul>'; // close the final section, and the parent ul
		$('#TOC').html('<ul id="tableOfContents">' + html +
					   '</ul><div class="clear"></div><hr class="padded" />');
	}

	function formatAndDisplayMAIN() {
		// Not required to be changed. Section controlled by Sections defined above.
		var keys = [];
		var keyToAdd = ''
		
		$.each(sectionsToDisplay, function(index, obj){
			keyToAdd=''
			if (obj.showOnly.length == 0 || (obj.showOnly.includes('party') == true && groupId == 'party') || (obj.showOnly.includes('leader') == true && ((userId == group.leader.id) || (userIsAdmin)))) {
				keyToAdd = obj.id
				if (obj.type == 'heading') keyToAdd = ''
				if (keyToAdd != '') keys.push(keyToAdd)
			}
		});
		if (debugShowObject) console.log(keys);
		
		var html = '';
		var functions = []; // functions to run after HTML code has been loaded
		var functionsPar = []; //Par to be passed in Function
		for (var i=0,ic=keys.length; i<ic; i++) {
			var data = MAIN[keys[i]];
			if (! data) {
				continue;
			}
			html += '<div id="' +
					data.id     + '"><h2>' +
					data.title  + '</h2>' +
					data.html   +
					((data.longContent) ? '<div class="mainSectionClose closer">' +
										  'close / back to top</div>' : '') +
					'</div>';
			if (data['function']) {
				functions.push(data['function']);
				functionsPar.push(data['functionPar']);
			}
		}
		$('#MAIN').html(html);
		// execute any functions that need to be run AFTER the bulk of the
		// HTML has been created:
		$.each(functions, function(index,fn){
			var passPar = functionsPar[index];
			fn(passPar);
		});
		if (sectionOpen && sectionOpen  !=  'documentationAndForm'
						&& sectionOpen  !=  'versionChanges'
		) {
			// reopen the section that the user had open before re-fetching
			// data (except for sections that don't display the user's own data):
			$('#' + sectionOpen).show();
			openRelatedSections();
		}
	}

	function refreshAndDisplayMAIN() {
		// Not required to be changed. Section controlled by Sections defined above.
		var keys = [];
		var keyToAdd = ''
		
		$.each(sectionsToDisplay, function(index, obj){
			keyToAdd=''
			if (obj.showOnly.length == 0 || (obj.showOnly.includes('party') == true && groupId == 'party') || (obj.showOnly.includes('leader') == true && ((userId == group.leader.id) || (userIsAdmin)))) {
				keyToAdd = obj.id
				if (obj.type == 'heading') keyToAdd = ''
				if (keyToAdd != '') keys.push(keyToAdd)
			}
		});
		if (debugShowObject) console.log(keys);
		
		var html = '';		
		var functions = []; // functions to run after HTML code has been loaded
		var functionsPar = []; //Par to be passed in Function
		for (var i=0,ic=keys.length; i<ic; i++) {
			var data = MAIN[keys[i]];
			if (! data) {
				continue;
			}

			html = data.refreshHtml
			$('#' + data.id + ' #' + data.refreshId).html(html)
			
			if (data['function']) {
				functions.push(data['function']);
				functionsPar.push(data['functionPar']);
			}
		}

		// execute any functions that need to be run AFTER the bulk of the
		// HTML has been created:
		$.each(functions, function(index,fn){
			var passPar = functionsPar[index];
			fn(passPar);
		});
		if (sectionOpen && sectionOpen  !=  'documentationAndForm'
						&& sectionOpen  !=  'versionChanges'
		) {
			// reopen the section that the user had open before re-fetching
			// data (except for sections that don't display the user's own data):
			$('#' + sectionOpen).show();
			openRelatedSections();
		}
	}

	openRelatedSections = function() {

	}
	
	function userDataInHeader() {
		var displayName = user.profile.nameNotPretty //renderFormattedText(user.profile.name);
		
		$('#headerExtras').html('<div id="userNameDisplay">' +
				displayName +
				'</div>' +
				'<div id="explanationAndClearLinks">' +
				'<input id="refetch" type="submit" value="' +
				'Re-Fetch Data (last fetched ' + fetchtime + ')" />' +
				'<span id="documentationAndFormToggle" class="showHideToggle" data-target="documentationAndForm" data-linktext="documentation / options" data-closemainsections="true">show documentation / options</span>' +
				'</div>'  				
				
		);
		$('#refetch').click(function(event){
			/* The user clicked on the Re-Fetch My Data button. */
			fetchData();
		});
	}
	
	//////////////////////////////////////////////////////////////////////
    ////   Formatting Functions used throughout  			  ////////////
    //////////////////////////////////////////////////////////////////////	
	
	function myDateConverter(date, style) { 

		var dateStr = '';
					
		if (style === 'pretty') {
			dateStr = moment(date).format('Do MMM YYYY, H:mm:ss');
		} else if (style === 'short') {
			if (date == neverDate) {
				dateStr = '-N/A-'
			} else {
				dateStr = moment(date).format('YYYY-MM-DD H:mm:ss');
			}
		} else if (style === 'long') {
			dateStr = moment(date).format('ddd Do MMMM YYYY, h:mm:ss a');
		} else if (style === 'utcTime') {
			dateStr = moment(date).utc().toISOString();
		} else if (style === 'relativeTime') {
			if (date == neverDate) {
				dateStr = '-N/A-'
			} else {
				dateStr = moment(date).fromNow();
			}
		}	else {
			var dateStr = moment(date).format(style);
		}
		return dateStr;
	}

	function renderFormattedText(text, options) {
		var md = window.habiticaMarkdown;
		if (text != undefined) {
			if (exportFormats[exportFormat].convertMarkup) text = md.render(text);
			if (exportFormats[exportFormat].removeHtml) text = $(text).text();
			if (exportFormats[exportFormat].convertLineBreaks) text = text.replace(/(?:\r\n|\r|\n)/g, '<br />');
			if (options && options.removeParaTags) {
				text = String(text).replace(/^<p>|<\/p>\n$/g, '');
			}
			else if (options && options.setParaClass) {
				text = String(text).replace(/<p>/g,
						   '<p class="' + options.setParaClass + '">');
			}
		}
		return text;
	}
	
	function toTitleCase(str)
	{
		return str.replace(/\w\S*/g, function(txt){return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();});
	}
	
	function constructTable(passPar) {
		//Called in Main to display table(s).
		//Will need to be added to add buttons and row selection on the fly.
		var formattedTableHeader = [];
		var dataSetSectionId = passPar[0];
		var dataSetTable = passPar[1];
		var dataSetTableHeader = passPar[2];
		var dataSetTableSection = passPar[3];
		
		var defaultShow = []
		var defaultOrderBy = []
		var buttonCollectionColumnOption = []
		var selectValue = false
		var showButtons = []
		var allColumnDefs = []
		
		var showOptions = []
		var hideOptions = []
		
		if (debug) console.log('debug constructTable ' + dataSetSectionId);		
		
		if ($('#'+ dataSetTableSection)[0].rows.length != 0){
			if (debug) console.log ('Table exists')

			var table = $('#'+ dataSetTableSection).DataTable();

			table.clear();
			table.draw();
				
			table.rows.add(dataSetTable);
			table.draw()
		} else {
			if (debug) console.log ('Table does not exists')
			//create column header
			$.each(dataSetTableHeader, function(index, obj){
				formattedTableHeader.push({'title': obj, 'classname': dataSetTableSection + '_' + obj.replace(/ /g, ''),  'defaultContent': ''})
			});
			
			if (debugShowObject) console.log(formattedTableHeader);
			
			
			showButtons = formatShowButton()
			
			if (debugShowObject) console.log(showButtons);

			allColumnDefs = [
				{ targets: defaultShow, visible: true},
				{ targets: '_all', visible: false }
			]
			allColumnDefs = allColumnDefs.concat(sectionTables[dataSetSectionId].extraColumnDefs)
			
			if (debugShowObject) console.log(allColumnDefs);

			
			sectionTables[dataSetSectionId].events = $('#events');
			$(document).ready(function() {
				sectionTables[dataSetSectionId].table = $('#'+ dataSetTableSection).DataTable( {
					data: dataSetTable,
					columns: formattedTableHeader,
					columnDefs: allColumnDefs,
					order: defaultOrderBy,
					lengthMenu: [ [10, 25, 50, 100, 200, 500, -1], [10, 25, 50, 100, 200, 500, "All"] ],
					select: selectValue, 
					dom: 'Bfrtip',
					buttons: showButtons
					
				} );
			} );
		}
		
		function formatShowButton() {
			var returnButtons = []
		
	
			//create export options
			$.each(exportOptions, function(index, obj){
				
				//Work out the hidden column list
				showOptions[obj.id] = eval('sectionTables[dataSetSectionId].' + obj.id + '.show')
				hideOptions[obj.id] = [];
				
				if (showOptions[obj.id][0] == 'all'){
					showOptions[obj.id] = []; // clear array
					for (i = 0; i < sectionTables[dataSetSectionId].dataTable.length; i++) { 
						showOptions[obj.id].push(i)
					}
					
				} else {
					for (i = 0; i < sectionTables[dataSetSectionId].dataTable.length; i++) { 
						if (showOptions[obj.id].indexOf(i) == -1) hideOptions[obj.id].push(i)
					}
				}
				buttonCollectionColumnOption.push({
									extend: 'colvisGroup',
									text: obj.shortDesc,
									show: showOptions[obj.id],
									hide: hideOptions[obj.id],
									className: 'columnGroupButton'
								})					
			});
			buttonCollectionColumnOption.push('columnsToggle')
			defaultShow = showOptions[exportOption]
			defaultOrderBy = eval('sectionTables[dataSetSectionId].' + exportOption + '.orderBy')
			
			if (debugShowObject) console.log(showOptions);		
			if (debugShowObject) console.log(hideOptions);	
		
			returnButtons = [
				 'pageLength', 
				 {
					extend: 'collection',
					text: 'Show/Hide',
					buttons: buttonCollectionColumnOption
				},
/*				{
					text: exportFormats[0].shortDesc,
					action: function ( e, dt, node, config ) {
						exportFormat = exportFormats[0].id;
						parseData();
					}
				},
				{
					text: exportFormats[1].shortDesc,
					action: function ( e, dt, node, config ) {
						exportFormat =  exportFormats[1].id;
						parseData();
					}
				},
				{
					text: exportFormats[2].shortDesc,
					action: function ( e, dt, node, config ) {
						exportFormat =  exportFormats[2].id;
						parseData();
						}
				},
*/				{
					extend: 'collection',
					text: 'Print/Copy/Export',
					buttons: [ 
						 {
							extend: 'print',
							exportOptions: {
								columns: ':visible'
							}
						}, {
							extend: 'copy',
							exportOptions: {
								columns: ':visible'
							}
						}, {
							extend: 'pdf',
							filename: 'BulkFeed',
							exportOptions: {
								columns: ':visible'
							}	
						}, {
							extend: 'excel',
							filename: 'BulkFeed',
							exportOptions: {
								columns: ':visible'
							}	
						}, {
							extend: 'csv',
							filename: 'BulkFeed',
							exportOptions: {
								columns: ':visible'
							}	
						}						
					],
					autoClose: true
				}
			]

			
			if (sectionTables[dataSetSectionId].extraButton != undefined) {
				var extraButton = sectionTables[dataSetSectionId].extraButton();
				returnButtons = returnButtons.concat(extraButton)
				selectValue = true
			}
			
			return returnButtons
		}
	}
	
	
	
	
	
	
	
	
	
	
	//////////////////////////////////////////////////////////////////////
    ////   Math Functions  					 ////////////
    //////////////////////////////////////////////////////////////////////
	function mean(numbers) {
	////   by Paul_Wilkins  					 ////////////
	// mean of [3, 5, 4, 4, 1, 1, 2, 3] is 2.875
		var total = 0,
			i;
		for (i = 0; i < numbers.length; i += 1) {
			total += numbers[i];
		}
		return total / numbers.length;
	}
	function median(numbers) {
	////   based on code by Paul_Wilkins  					 ////////////
		// median of [3, 5, 4, 4, 1, 1, 2, 3] = 3
		var median = 0,
			numsLen = numbers.length;
		numbers.sort(function(a, b){return a - b});
		if (numsLen % 2 === 0) { // is even
			// average of two middle numbers
			median = (numbers[numsLen / 2 - 1] + numbers[numsLen / 2]) / 2;
		} else { // is odd
			// middle number only
			median = numbers[(numsLen - 1) / 2];
		}
		return median;
	}
	function mode(numbers) {
	////   by Daniel http://danielpike.me.uk/finding-mode-element-in-an-array/ 					 ////////////

	    var mode = {};
		var max = 0, count = 0;

		numbers.forEach(function(e) {
			if (mode[e]) { mode[e]++; }
			else { mode[e] = 1; } 

			if (count<mode[e]) { 
				max = e;
				count = mode[e];
			}
		});
		
		return max;
	}
	
	function range(numbers) {
		numbers.sort(function(a, b){return a - b});
		return (String(numbers[0]) + ' to ' + String(numbers[numbers.length - 1]))
	}
	
	function smallest(numbers) {
		numbers.sort(function(a, b){return a - b});
		return (numbers[0])
	}
	
	function largest(numbers) {
		numbers.sort(function(a, b){return a - b});
		return (numbers[numbers.length - 1])
	}

	
	
	//////////////////////////////////////////////////////////////////////
    ////   Collate and Display Data  					 ////////////
    //////////////////////////////////////////////////////////////////////
	function collateAndDisplayData() {
	
	
		//format collate Data -- one function
		formatAllDataAndCollate();
		
		//run functions to create for TOC / MAIN 
		$.each(sectionsToDisplay, function(index, obj){
			if (obj.type == 'sectionTable') {
				if (obj.showOnly.length == 0 || (obj.showOnly.includes('party') == true && groupId == 'party') || (obj.showOnly.includes('leader') == true && ((userId == group.leader.id) || (userIsAdmin)))) {
					formatTableSection(obj.id, obj.title)
				}
			} else if (obj.type == 'sectionCustom') {
				var fn = obj.functionCreate
				eval(fn + '("' + obj.id + '", "' + obj.title + '")')
			}
			
		});
		
		
		
	//////////////////////////////////////////////////////////////////////
    //     Prep data before using                            ////////////
	//
	//     This is where you modify data to be used throughout
	//     All data is modified here
    //////////////////////////////////////////////////////////////////////
		
		function formatAllDataAndCollate() {
			pets = {};
			eggs = {};
			potions = {};
			food = {};
			sellItems = {};
			triadBingoRequirement = {};
			canTriadBingo = true;
			
			
			var arrayToAdd = []; //Used to create final array to add to dataSet
			
			//arrays to construct stuff because I like altering things in one place than trailing through code... (Didn't do too well with this section).	
			var foodTarget = {Base: 'Meat', CottonCandyBlue: 'CottonCandyBlue', CottonCandyPink: 'CottonCandyPink', Desert: 'Potatoe', Golden: 'Honey', Red: 'Strawberry', Shade: 'Chocolate', Skeleton: 'Fish', White: 'Milk', Zombie: 'RottenMeat'}

			var petTypes = {drop: 'Standard (Gen1)', premium: 'Magic Potion', quest: 'Quest', special: 'Rare', wacky: 'Wacky' } 
			
			///////////////////////////////////////////////////////////////
			////   Single   Data                              ////////////
			//////////////////////////////////////////////////////////////
			if (debug) console.log('debug formatAllDataAndCollate Single Data Variables');
			
			
			//User
			modifyUserProperties()	
			
			user.feedStats = {}
			user.feedStats.notHatchCount = 0			
			user.feedStats.petFeedCount = 0
			user.feedStats.mountCount = 0
			user.feedStats.petNoFeedCount = 0
			user.feedStats.petRareCount = 0
			user.feedStats.mountRareCount = 0
			user.feedStats.notHatchBaseCount = 0
			user.feedStats.petFeedBaseCount = 0
			user.feedStats.mountBaseCount = 0
			user.feedStats.petNoFeedBaseCount = 0
			user.feedStats.eggBaseCount = 0
			user.feedStats.potionBaseCount = 0
			
			user.feedStats.food = {}
			$.each(foodTarget, function(index, obj){
				user.feedStats.food[index] = 0
			});
			user.feedStats.food.all = 0

			// Loop through all pets to create a base all items to be populated (avoid messy undefines later)
			//Food
			$.each(content.food, function(index, obj){
				if (obj.target != undefined) {
					food[index] = obj
					if (showImage) {
						food[index].imgTag = '<img src="' + imageURL + imageStableFood + index + imageFileSuffix + '" alt="' + obj.text + '">'
					} else {
						food[index].imgTag = ''
					}
					
					if (user.items.food[index] != undefined) {
						food[index].total = user.items.food[index]
					} else {
						food[index].total = 0 
					}
					
					
					
					if (food[index].total > 0) sellItems['food_' + index] = {imgTag: food[index].imgTag, key: index, category: 'food', type: '', text: food[index].text, note: food[index].notes, value: food[index].value, total: food[index].total}
					
					user.feedStats.food[obj.target] += food[index].total
					user.feedStats.food.all += food[index].total
				}
			});			

			//Eggs
			$.each(content.eggs, function(index, obj){
					eggs[index] = obj
					if (showImage) {
						eggs[index].imgTag = '<img src="' + imageURL + imageStableEgg + index + imageFileSuffix + '" alt="' + obj.text + '">'
					} else {
						eggs[index].imgTag = ''
					}
					if (user.items.eggs[index] != undefined) {
						eggs[index].total = user.items.eggs[index]
					} else {
						eggs[index].total = 0 
					}
					
					
					if (eggs[index].total > 0) sellItems['egg_' + index] = {imgTag: eggs[index].imgTag, key: index, category: 'egg', type: '', text: eggs[index].text, note: eggs[index].notes, value: eggs[index].value, total: eggs[index].total} //type will be filled out later
					
					//Set up empty stats
					eggs[index].feedStats = {}
					eggs[index].feedStats.count = 0
					eggs[index].feedStats.notHatchCount = 0
					eggs[index].feedStats.petFeedCount = 0
					eggs[index].feedStats.mountCount = 0
					eggs[index].feedStats.petNoFeedCount = 0
					eggs[index].feedStats.hatchSpaceCount = 0
					eggs[index].feedStats.allPetsFed = false
					eggs[index].feedStats.petFeedList = ''
					
					if (content.dropEggs[index] != undefined) {
						triadBingoRequirement['egg_' + index] = {imgTag: eggs[index].imgTag, key: index, category: 'egg', text: eggs[index].text + ' Egg', require: 20, need: 20, have: 0, missing: 999} //have and missing filled out later
					}
			});	

			//Potions
			$.each(content.hatchingPotions, function(index, obj){
					var typePotion = ''
					potions[index] = obj
					if (showImage) {
						potions[index].imgTag = '<img src="' + imageURL + imageStablePotion + index + imageFileSuffix + '" alt="' + obj.text + '">'
					} else {
						potions[index].imgTag = ''
					}

					if (potions[index].wacky == undefined) potions[index].wacky = false //not always set in the data.
					if (potions[index].premium == true) {
						typePotion = 'Magic Potion' 
					} else if (potions[index].wacky == true) {
						typePotion = 'Wacky' 
					} else { 
						typePotion = petTypes['drop']
					}

					if (user.items.hatchingPotions[index] != undefined) {
						potions[index].total = user.items.hatchingPotions[index]
					} else {
						potions[index].total = 0 
					}
					
					if (potions[index].total > 0) sellItems['potion_' + index] = {imgTag: potions[index].imgTag, key: index, category: 'potion', type: typePotion, text: potions[index].text, note: potions[index].notes, value: potions[index].value, total: potions[index].total}

					//Set up empty stats
					potions[index].feedStats = {}
					potions[index].feedStats.count = 0
					potions[index].feedStats.notHatchCount = 0 
					potions[index].feedStats.petFeedCount = 0
					potions[index].feedStats.mountCount = 0
					potions[index].feedStats.petNoFeedCount = 0

					if (potions[index].premium == true) {
						potions[index].foodAvail = user.feedStats.food.all
					} else if (potions[index].wacky == true) {
						potions[index].foodAvail = ''
					} else {
						potions[index].foodAvail = user.feedStats.food[index]
					}
					
					if (content.dropHatchingPotions[index] != undefined) {
						triadBingoRequirement['potion_' + index] = {imgTag: potions[index].imgTag, key: index, category: 'potion', text: potions[index].text + ' Potion', require: 18, need: 18, have: 0, missing: 999} //have and missing filled out later
						triadBingoRequirement['food_' + index] = {imgTag:  food[foodTarget[index]].imgTag, key: index, category: 'food', text: potions[index].text + ' Food', require: 81, need: 81, have: 0, missing: 999} //have and missing filled out later
					}
					
					
			});	

			//Pets
			$.each(content.petInfo, function(index, obj){
				if (obj.type != 'special') {
					pets[index] = obj
					if (showImage) {
						pets[index].imgTag = '<img src="' + imageURL + imageStablePet + index + imageFileSuffix + '" alt="' + obj.text + '">'
					} else {
						pets[index].imgTag = ''
					}
					
					pets[index].typePretty = petTypes[obj.type]
					pets[index].eggPretty = eggs[pets[index].egg].text
					pets[index].potionPretty = potions[pets[index].potion].text
					pets[index].canHatch = 'false' //will be altered throughout if statements if required
					if ((eggs[pets[index].egg].total > 0 ) && (potions[pets[index].potion].total > 0)) pets[index].canHatch = 'true'
					
					if ((obj.type != 'premium') && (obj.type != 'wacky')) eggs[pets[index].egg].feedStats.count++
					potions[pets[index].potion].feedStats.count++
					if ((obj.type != 'premium') && (obj.type != 'wacky')) eggs[pets[index].egg].feedStats.type = obj.typePretty
					if ((obj.type != 'premium') && (obj.type != 'wacky')) if (sellItems['egg_' + pets[index].egg] != undefined) sellItems['egg_' + pets[index].egg].type = obj.typePretty
					
					//Does User have Pet & Mount?
					if (user.items.pets[index] != undefined && user.items.pets[index] != 0) {
						if (user.items.mounts[index] == true) {
							pets[index].mount = true
							user.feedStats.mountCount++
							if (obj.type == 'drop') user.feedStats.mountBaseCount++
							if ((obj.type != 'premium') && (obj.type != 'wacky'))  eggs[pets[index].egg].feedStats.mountCount++
							potions[pets[index].potion].feedStats.mountCount++
						
							pets[index].feedValue = 0
							if (user.items.pets[index] > 0) {
								pets[index].pet = true
								pets[index].canHatch = '-N/R-'
								if ((obj.type != 'premium') && (obj.type != 'wacky'))  eggs[pets[index].egg].feedStats.petNoFeedCount++
								potions[pets[index].potion].feedStats.petNoFeedCount++
								user.feedStats.petNoFeedCount++
								if (obj.type == 'drop') user.feedStats.petNoFeedBaseCount++
								
							} else {
								pets[index].pet = false
							}
							
							pets[index].foodAvail = undefined

						} else {
							pets[index].mount = false
							
							pets[index].feedValue = user.items.pets[index] * 2 / 10
							if (user.items.pets[index] > 0) {
								pets[index].pet = true
								if ((obj.type != 'premium') && (obj.type != 'wacky'))  eggs[pets[index].egg].feedStats.petFeedCount++
								potions[pets[index].potion].feedStats.petFeedCount++
								user.feedStats.petFeedCount++
								if (obj.type == 'drop') user.feedStats.petFeedBaseCount++	
								if (pets[index].canHatch == 'true' ) pets[index].canHatch = 'Once Fed'
								if ((obj.type != 'premium') && (obj.type != 'wacky'))  eggs[pets[index].egg].feedStats.petFeedList += ', ' + potions[pets[index].potion].text 
							} else {
								pets[index].pet = false
							}
							
							if (obj.type == 'premium') {
								pets[index].foodAvail = user.feedStats.food.all
							} else if (obj.type == 'wacky') {
								pets[index].foodAvail = undefined
							} else {
								pets[index].foodAvail = user.feedStats.food[obj.potion]
							}
						}
					} else {
						pets[index].feedValue = 0
						pets[index].mount = false
						pets[index].pet = false
						if ((obj.type != 'premium') && (obj.type != 'wacky'))  eggs[pets[index].egg].feedStats.notHatchCount++
						potions[pets[index].potion].feedStats.notHatchCount++
						user.feedStats.notHatchCount++
						if (obj.type == 'drop') user.feedStats.notHatchBaseCount++	

						if (obj.type == 'premium') {
							pets[index].foodAvail = user.feedStats.food.all
						} else if (obj.type == 'wacky') {
							pets[index].foodAvail = undefined
						} else {
							pets[index].foodAvail = user.feedStats.food[obj.potion]
						}
					}
					
					//wacky pets clean up
					if (pets[index].type == 'wacky') {
						if (pets[index].pet) pets[index].canHatch = '-N/R-'
						pets[index].feedValue = 0					
					}



					//triad Bingo
					if (pets[index].type == 'drop') {				
						//Do we need food? Do we have a mount?
						if (pets[index].mount == true) {
							//No food required
							triadBingoRequirement['food_' + pets[index].potion].require -= 9
							
							//Do we need another egg and potion?
							if (pets[index].pet == true){
								triadBingoRequirement['egg_' + pets[index].egg].require -= 2
								triadBingoRequirement['potion_' + pets[index].potion].require -= 2
							} else {
								triadBingoRequirement['egg_' + pets[index].egg].require -= 1
								triadBingoRequirement['potion_' + pets[index].potion].require -= 1
							}
						} else {
							//No mount need food
							if (pets[index].pet == true) {
								//require some food require and only  1 egg
								triadBingoRequirement['food_' + pets[index].potion].require -= (pets[index].feedValue - 1) //Always start with 1 if there is a pet
								triadBingoRequirement['egg_' + pets[index].egg].require -= 1
								triadBingoRequirement['potion_' + pets[index].potion].require -= 1
							}
						}
					}
					
				} else {
					if (user.items.pets[index] > 0) user.feedStats.petRareCount++
					if (user.items.mounts[index] == true) user.feedStats.mountRareCount++
				}
				
			});
		
			
			///////////////////////////////////////////////////////////////
			////   Process Sections / Table / Count Values     ////////////
			//////////////////////////////////////////////////////////////
			if (debug) console.log('debug formatAllDataAndCollate Secion/tableData');
			
			//Clear arrays
			$.each(sectionsToDisplay, function(index, obj){
				if (obj.type == 'sectionTable'){
					sectionTables[obj.id].dataSet=[];
				}
			});
			if (debugShowObject) console.log(sectionTables);	
			
						
			///////////////////////////////////////////////////////////////
			////   Potions									  ////////////
			//////////////////////////////////////////////////////////////
			$.each(potions, function(index, obj){
				
				$.each(sectionsToDisplay, function(index2, obj2){
					if (obj2.type == 'sectionTable' ) {
						if (sectionTables[obj2.id].type == 'potions'){
							addToArray = []; //clear array
							$.each(sectionTables[obj2.id].dataTable, function(index3, obj3){
								addToArray.push(eval('obj.' + obj3))
							});
							sectionTables[obj2.id].dataSet.push(addToArray);
						}
					}
				});
			});
			if (debug) console.log('Finish potions');

			///////////////////////////////////////////////////////////////
			////   Eggs										  ////////////
			//////////////////////////////////////////////////////////////
			$.each(eggs, function(index, obj){
				obj.feedStats.hatchSpaceCount = 10 - obj.feedStats.petNoFeedCount - obj.feedStats.petFeedCount  
				if (obj.feedStats.petNoFeedCount == 10) obj.feedStats.allPetsFed = true
				if (obj.feedStats.petFeedList != '') obj.feedStats.petFeedList = obj.feedStats.petFeedList.substring(2)
				
				$.each(sectionsToDisplay, function(index2, obj2){
					if (obj2.type == 'sectionTable' ) {
						if (sectionTables[obj2.id].type == 'eggs'){
							addToArray = []; //clear array
							$.each(sectionTables[obj2.id].dataTable, function(index3, obj3){
								addToArray.push(eval('obj.' + obj3))
							});
							sectionTables[obj2.id].dataSet.push(addToArray);
						}
					}
				});
			});
			if (debug) console.log('Finish eggs');


			///////////////////////////////////////////////////////////////
			////   Food										  ////////////
			//////////////////////////////////////////////////////////////
			$.each(food, function(index, obj){
				
				$.each(sectionsToDisplay, function(index2, obj2){
					if (obj2.type == 'sectionTable' ) {
						if (sectionTables[obj2.id].type == 'food'){
							addToArray = []; //clear array
							$.each(sectionTables[obj2.id].dataTable, function(index3, obj3){
								addToArray.push(eval('obj.' + obj3))
							});
							sectionTables[obj2.id].dataSet.push(addToArray);
						}
					}
				});
			});
			if (debug) console.log('Finish food');


			///////////////////////////////////////////////////////////////
			////   Sell Items										  ////////////
			//////////////////////////////////////////////////////////////
			$.each(sellItems, function(index, obj){
				
				$.each(sectionsToDisplay, function(index2, obj2){
					if (obj2.type == 'sectionTable' ) {
						if (sectionTables[obj2.id].type == 'sellItems'){
							addToArray = []; //clear array
							$.each(sectionTables[obj2.id].dataTable, function(index3, obj3){
								addToArray.push(eval('obj.' + obj3))
							});
							sectionTables[obj2.id].dataSet.push(addToArray);
						}
					}
				});
			});
			if (debug) console.log('Finish sellItems');

			///////////////////////////////////////////////////////////////
			////   Pets										  ////////////
			//////////////////////////////////////////////////////////////
			$.each(pets, function(index, obj){
				
				$.each(sectionsToDisplay, function(index2, obj2){
					if (obj2.type == 'sectionTable' ) {
						if (sectionTables[obj2.id].type == 'pets'){
							addToArray = []; //clear array
							$.each(sectionTables[obj2.id].dataTable, function(index3, obj3){
								addToArray.push(eval('obj.' + obj3))
							});
							sectionTables[obj2.id].dataSet.push(addToArray);
						}
					}
				});
			});
			if (debug) console.log('Finish pets');

			///////////////////////////////////////////////////////////////
			////   Triad Bingo 								  ////////////
			//////////////////////////////////////////////////////////////
			if (debugShowObject) console.log(triadBingoRequirement);
			var missingItem;
			var requireTotal = 0;
			$.each(triadBingoRequirement, function(index, obj){
				missingItem = false;
				requireTotal += obj.require;
				
				if (obj.category == 'egg') {
					if (eggs[obj.key].total != undefined) obj.have = eggs[obj.key].total
				} else if (obj.category == 'potion') {
					if (potions[obj.key].total != undefined) obj.have = potions[obj.key].total
				} else if (obj.category == 'food') {
					if (user.feedStats.food[obj.key] != undefined) obj.have = user.feedStats.food[obj.key]
				}
				if (obj.have < obj.require ) {
					missingItem = true;
				}
				obj.missing = obj.require - obj.have
				
				if (missingItem) {
					canTriadBingo = false;
					$.each(sectionsToDisplay, function(index2, obj2){
						if (obj2.type == 'sectionTable' ) {
							if (sectionTables[obj2.id].type == 'triadBingoRequirement'){
								addToArray = []; //clear array
								$.each(sectionTables[obj2.id].dataTable, function(index3, obj3){
									addToArray.push(eval('obj.' + obj3))
								});
								sectionTables[obj2.id].dataSet.push(addToArray);
							}
						}
					});
				}
			});
			if (requireTotal == 0) canTriadBingo = false;
			if (debug) console.log('Finish triad bingo');
						
			///////////////////////////////////////////////////////////////
			////   Action Log								 ////////////
			//////////////////////////////////////////////////////////////
			$.each(actionLog, function(index, obj){
				modifyActionLog(obj)
				
				$.each(sectionsToDisplay, function(index2, obj2){
					if (obj2.type == 'sectionTable' ) {
						if (sectionTables[obj2.id].type == 'actionLog'){
							addToArray = []; //clear array
							$.each(sectionTables[obj2.id].dataTable, function(index3, obj3){
								addToArray.push(eval('obj.' + obj3))
							});
							sectionTables[obj2.id].dataSet.push(addToArray);
						}
					}
				});
			});
			if (debug) console.log('Finish actionLog');

			if (debugShowObject) console.log(sectionTables);
			
		};
		
		//////////////////////////////////////////////////////////////////////
		////   Formatting data for data sets     ///////////////////////////
		//////////////////////////////////////////////////////////////////////
		function modifyUserProperties(obj) {
			if (user.profile !=  undefined ){
				if (user.profile.blurb  !=  undefined ) {
					user.blurbPretty  = renderFormattedText(user.profile.blurb)
				} else
				{
					user.blurbPretty  = ''
				}
			} else
			{
				user.blurbPretty  = ''
			};
			if (user.id == 'system') {
				user.profile.namePretty = 'System'
				user.profile.nameNotPretty = 'System'
				user.profile.nameLink = 'System'
			} else {
				user.profile.namePretty = renderFormattedText(user.profile.name);
				user.profile.nameNotPretty = renderFormattedText(user.profile.name, {removeParaTags: true});
				user.profile.nameLink = '<a href="https://habitica.com/static/front#?memberId=' + user.id +'" target="_blank">' + user.profile.nameNotPretty + '</a>'
			}
			if (user.stats.class == 'wizard')  {
				user.stats.classPretty = 'mage'
			} else {
				user.stats.classPretty = user.stats.class
			}
			user.inbox.canPM = !user.inbox.optOut;
			user.creation  = reformatDate(user.auth.timestamps.created);
			var nextBirthday = moment({
											year: moment().year(),
											month: moment(user.auth.timestamps.created).month(),
											day: moment(user.auth.timestamps.created).date(),
											hour: moment(user.auth.timestamps.created).hour(),
											minute: moment(user.auth.timestamps.created).minute(),
											second: moment(user.auth.timestamps.created).second()
										})
			if (moment() > nextBirthday) nextBirthday = moment({
											year: moment().year()+1,
											month: moment(user.auth.timestamps.created).month(),
											day: moment(user.auth.timestamps.created).date(),
											hour: moment(user.auth.timestamps.created).hour(),
											minute: moment(user.auth.timestamps.created).minute(),
											second: moment(user.auth.timestamps.created).second()
										})
			
			user.creation.nextBirthday =  reformatDate(nextBirthday)
			
			
			user.lastLoggedIn  = reformatDate(user.auth.timestamps.loggedin);
			user.lastDropItem  = reformatDate(user.items.lastDrop.date);
			//if (debugShowObject) console.log(obj);
			if (user.contributor  !=  undefined ) {
				if (user.contributor.text  !=  undefined ) {
					user.contribPretty = [];
					user.contribPretty.text = user.contributor.text;
					if (user.contributor.level != undefined)	{
						user.contribPretty.level = user.contributor.level
					} else {
						user.contribPretty.level = '';
					};
					if (user.contributor.contributions  !=  undefined){
						user.contribPretty.contributions = user.contributor.contributions;
					} else {
						user.contribPretty.contributions = '';
					}
					if (user.contributor.admin === true) {
						user.contribPretty.admin = true
					} else {
						user.contribPretty.admin  = false
					}
				} else {
					user.contribPretty = [];
					user.contribPretty.text = '';
					user.contribPretty.level = '';
					user.contribPretty.contributions = '';
					user.contribPretty.admin = false;
				}
			} else {
				user.contribPretty = [];
				user.contribPretty.text = '';
				user.contribPretty.level = '';
				user.contribPretty.contributions = '';
				user.contribPretty.admin = false;
			}
			
		}
		
		function modifyActionLog(obj) {
			obj.creation  = reformatDate(obj.epoch);
		}
		
		function reformatDate(dateString) {
				var formattedDate = myDateConverter(dateString, 'long');
				var shortDate     = myDateConverter(dateString, 'short');
				var relativeTime  = myDateConverter(dateString, 'relativeTime');
				var utcTime  = myDateConverter(dateString, 'utcTime');
				return { 'dateAndTime': formattedDate,
						 'shortDate': shortDate,
						 'relativeTime': relativeTime,
						 'utcTime': utcTime
				};
		}
		
		
		//////////////////////////////////////////////////////////////////////
		////   Sections 										   ////////////
		//////////////////////////////////////////////////////////////////////
		//Custom Section functions here.

		//////////////////////////////////////////////////////////////////////
		//sectionTable Functions
		//////////////////////////////////////////////////////////////////////
		function formatTableSection(sectionId, title){
			var id    = sectionId + 'Section';
			var orderId = sectionId;
			var tableSectionId = sectionId + 'display';
			var subTitle = sectionTables[sectionId].subTitle()
			var refreshId = sectionId + SECTIONREFRESH 
			var html = formatTableData(subTitle, refreshId, tableSectionId);
			if (! html) {
				return;
			}
			TOC[orderId] = {'target': id, 'title':  title};
			MAIN[orderId] = {'id': id, 'title': title, 'longContent': true,
				'html': html, 'refreshHtml': subTitle, 'refreshId': refreshId,
				'dataSetTblSection': tableSectionId, 'function': constructTable, 
				'functionPar':  [sectionId, sectionTables[sectionId].dataSet, sectionTables[sectionId].dataSetHeader, tableSectionId]};
		}
		
		
		//Function used by sections to create HTML To display table
		function formatTableData(subText, refreshId, tableId) {
			//Used by sections above if a table is required in there HTML
			var html = '';
			
			html += '<table id="' + tableId + '" class="display" width="100%"></table>'

			if (html) {
				return '<span id="' + refreshId + '">' + subText + '</span><p><div id="headerExport"></div></p>' + html ;
			}
			else {
				return '';
			}
		}

	}
	
}


if (debug) console.log('debug 99');	
});
</script>	


<style>

/*********************************************************************
****   Page-wide   ***************************************************
*********************************************************************/
body {
    font-family: Helvetica, Arial, sans-serif;
    font-size: 14px;
    background-color: rgb(173, 208, 215);
}



#innerBody {
    margin: 20px;
    padding: 5px 20px 30px 20px;
    background-color: rgb(242, 242, 230);
}
#loading {
    margin-right: 30px;
    margin-left: 30px;
    color: orange;
    font-size: 1.5em;
    font-weight: bold;
}
#loading ul {
    font-size: 0.8em;
}
#loading ul a {
    color: orange;
}


#posting {
    margin-right: 30px;
    margin-left: 30px;
    color: orange;
    font-size: 1.5em;
    font-weight: bold;
}
#posting ul {
    font-size: 0.8em;
}
#posting ul a {
    color: orange;
}

.narrowContent {      /* The data should be as wide as the user's window   */
    max-width: 500px; /* but some explanatory paragraphs should be narrow. */
}


hr {
    width: 95%;
}
hr.padded {
    margin-top:    1em;
    margin-bottom: 2em;
}

.show {
    display: block;
}
.hide {
    display: none;
}
.clear {
    clear: both;
}

.spoiler {
    font-weight: bold;
	font-size: 250%;
	color: orange;
}
.subheading {
    font-weight: bold;
}
.highlight {
    font-weight: bold;
}
.lowlight { /* like highlight but less so */
    font-style: italic;
}
.explanation {
    font-style: italic;
}
abbr {
    border-bottom: 1px dashed black;
}
img.emoji {
    margin-bottom: -0.25em;
}
.forCopyPaste {
    /* used to add blank lines that we want when copying text to clipboard,
       but we don't want to see extra whitespace on the screen */
    margin-top: -1em;
}
ul.padded > li {
    padding: 3px 0;
}

.neutral {
    background-color: #fffbd0; /* yellow */
}
.danger {
    background-color: #ffcccc; /* red */
    /* background-color: #F5A9A9; */ /* darker red */
}
.safe {
    background-color: #bdd8fc; /* blue */
    /* green+red and green+yellow are not good for colour-blind people */
}


/*********************************************************************
****   Page-wide Data Tables   ********************************
*********************************************************************/

a.dt-button.hatchPetButton {
	color: orange;
}

a.dt-button.manualFeedPetButton {
	color: orange;
}

a.dt-button.feedPetButton {
	color: orange;
}

a.dt-button.sellButton {
	color: orange;
}


div.dt-button-collection {
	width: 180px;
}

/*********************************************************************
****   Page-wide Show/Hide Toggling   ********************************
*********************************************************************/
.mainSectionClose,
.showHideToggle,     /* for toggling by id */
.showHideToggleClass /* for toggling by class */
{
    cursor: pointer;
    text-decoration: underline;
    color: purple;
}
.closer { /* as in "a thing that closes", not "nearer" */
    margin-top: 30px;
    padding-top: 15px;
    padding-bottom: 15px;
}
.closer:hover {
    border: 1px dashed lightgrey;
}
.developerData {
    font-family: monospace;
}


/*********************************************************************
****   Header   ******************************************************
*********************************************************************/
h1 {
    float: left;
}
h1>a:first-child { /* "Habitica" link in header */
    color: black;
    text-decoration: none;
}
h1>a:first-child:hover { /* "Habitica" link in header */
    text-decoration: underline;
}
h1 span {
    font-size: 0.5em;
}
h2 {
    margin-top: 30px;
}

#headerExtras .showHideToggle {
    white-space: nowrap;
}
#userNameDisplay {
    text-align: right;
    font-weight: bold;
    font-size: 2em;
    margin-bottom: 10px;
}

#groupNameDisplay {
    text-align: left;
    font-weight: bold;
    font-size: 2em;
    margin-bottom: 10px;
}

#explanationAndClearLinks {
    text-align: right;
}
#explanationAndClearLinks span {
    padding-left: 10px;
}


/*********************************************************************
****   Version History   *********************************************
*********************************************************************/

#versionChanges dl {
    margin-left: 30px;
}
#versionChanges dl dt {
    font-size: 1.15em;
    font-weight: bold;
}
#versionChanges dl dt .date {
    padding-left: 10px;
    font-size: 0.8em;
    font-weight: normal;
}
#versionChanges .showHideToggle {
    padding-bottom: 15px;
    margin-bottom: 10px;
}

/*********************************************************************
****   API Form and Documentation   **********************************
*********************************************************************/

#documentationAndForm > div {
    max-width: 700px;
}
#documentationAndForm #documentationAndFormClose {
    display: none;
    max-width: 100%;
}
#documentationAndForm div h2 {
    font-size: 1.3em;
}
#documentationAndForm li {
    margin-bottom: 10px;
}

#userApiDetailsForm {
    margin: 30px;
}
#userApiDetailsForm fieldset {
    max-width: 40em;
}
#userApiDetailsForm fieldset label,
#userApiDetailsForm fieldset input[type="submit"] {
    display: block;
    float: left;
    clear: left;
    margin: 10px 0;
}
#userApiDetailsForm fieldset label span {
    display: block;
    float: left;
    width: 8em;
}
#userApiDetailsForm fieldset label input {
    float: left;
    width: 30em;
}
#userApiDetailsForm input[type="checkbox"] {
    width: auto;
}
#userApiDetailsForm fieldset p {
    clear: both;
}
#userApiDetailsForm legend .highlight {
    font-size: 1.3em;
}
#userApiDetailsForm fieldset li {
    margin-bottom: 7px;
}




/*********************************************************************
****   Dashboard   ***************************************************
*********************************************************************/
#DASHBOARD ul {
    float: left;
}
#DASHBOARD li {
    text-align: center;
    width: 120px;
    background-color: #fffbd0; /* yellow */
    border: 1px;
    padding: 4px;
    margin-right: 4px;
    float: left;
    list-style-type: none;
}
#DASHBOARD li.showHideToggle {
    text-decoration: none;
    color: black;
}
#DASHBOARD li > div {
    box-shadow: 1px 1px 1px 1px #666666;
}
#DASHBOARD .value {
    font-size: 2.15em;
    font-weight: bold;
    padding: 2px;
}
#DASHBOARD .label {
    font-size: 0.75em;
    padding: 1px;
}
#DASHBOARD .dropCap {
    font-size: 0.7em;
}


/*********************************************************************
****   Table Of Contents   *******************************************
*********************************************************************/
ul#tableOfContents {
    list-style-type: none;
}
ul#tableOfContents ul {
    list-style-type: none;
    margin-left: 1em;
    padding: 0;
}
ul#tableOfContents li {
    font-size: 1.1em;
    padding: 2px 0;
}
ul#tableOfContents > li {
    float: left;
    margin-right: 20px;
}


/*********************************************************************
****   Specific Sections   *******************************************
*********************************************************************/
#MAIN > * {
    display: none; /* all sections hidden by default */
}

#overviewSection h1 {
	 float: none
}

#overviewSection table tr td {
    border: 2px solid lightgrey;
	text-align: center;
	padding: 5px;
}
</style>
</head>
<body><div id="innerBody">	
<h1><a href="https://habitica.com/">Habitica</a> Bulk Feed Pets Tool
    <span class="showHideToggle" data-target="versionChanges" data-closemainsections="true">(v2.0)</span></h1><!-- VERSION TOGGLE -->
<div id="headerExtras"></div>
<hr class="clear" />



<div id="loading">
    <div class="good hide">
        <p>Please wait. Fetching data from
        <span id="serverName">Habitica</span>... <span id="statusFetch"></span></p>
    </div>
    <div class="bad hide">
        <p>There was an error obtaining your data.</p>
        <ul class="padded">
            <li>Please reload the page and then check that your <a href="https://habitica.com/user/settings/api">User ID and API Token</a> are correct.</li>
            <li>If you're using Internet Explorer, try another browser. <a href="https://www.google.com/intl/en/chrome/browser/">Chrome</a> or <a href="https://www.mozilla.org/en-US/firefox/new/">Firefox</a> will be more reliable.</li>
            <li>If the page's URL starts with "http://" change it to start with "https://" (or just use <a href="https://oldgods.net/habitica/cTheDragons/feed.html">this correct link</a>).</li>
            <li>If neither of those help, contact me! See <strong>"Help and Contact Details"</strong> at the bottom of this page.</li>
        </ul>
    </div>
</div>
<div id="posting">
	<div class="good hide">
		<p>Please wait. Posting data to
		<span id="serverName">Habitica</span>... <span id="statusPost"></span></p>
	</div>
</div>

<div id="versionChanges" class="hide"><!-- VERSION SECTION -->
    <h2>Version History</h2>
    <dl>
		<dt>2.0 - Just Wacky<span class="date">2019-05-03</span></dt>
        <dd><ul>
	            <li>Features:
                <ul>
					<li>Added Wacky type</li>
					<li>Stopped Wacky Pets being feed.</li>
				</ul> 
            </li>
	        <li>Documentation:
                <ul>
					<li>Add all x-client calls except content (no header required)</li>
                </ul>
            </li>		
	        <li>Bug Fixes:
                <ul>
					<li>Added delay to feeding, hatching and selling to avoid sever overload.</li>
					<li>Better error handling when JSON Message not available.</li>
               </ul>
            </li>
		</ul></dd>		
		<dt>1.8 - Bits for Bob the Pet<span class="date">2017-02-24</span></dt>
        <dd><ul>
	        <li>Documentation:
                <ul>
					<li>Rename of Feed all Pets to Triad Bingo.</li>
                </ul>
            </li>		
	        <li>Bug Fixes:
                <ul>
					<li>Url parameters apply independent of whether or not the user id parameter is supplied. (Thank you @Accio Books!)</li>
					<li>Checkbox url parameter can be set to false.</li>
               </ul>
            </li>
		</ul></dd>	
		<dt>1.7 - Be Free My Pretty Ones!<span class="date">2017-11-14</span></dt>
        <dd><ul>
	            <li>Features:
                <ul>
					<li>Added Release Triad Bingo Button.</li>
					<li>Showing All Pets Fed, Hatch Spaces and Pet Feed List.</li>
					<li>Updating URL to new website format.</li>
					<li>Better error with POST functions handling.</li>
				</ul> 
            </li>
	        <li>Documentation:
                <ul>
					<li>Clean up of code.</li>
					<li>Minor fixes to formatting of check boxes.</li>
					<li>Rename to Standard to match new naming convention for Gen 1 Pets</li>
                </ul>
            </li>		
	        <li>Bug Fixes:
                <ul>
					<li>Not Hatched totals are now corrected for Released Gen 1 Pets</li>
               </ul>
            </li>
		</ul></dd>		
		<dt>1.6 - Odd Bug<span class="date">2017-09-16</span></dt>
        <dd><ul>
	        <li>Bug Fixes:
                <ul>
					<li>Fix unable to sell or hatch items due extra "/"</li>
				</ul>
            </li>
		</ul></dd>
		<dt>1.5 - Force Feed<span class="date">2017-08-27</span></dt>
        <dd><ul>
	        <li>Documentation:
                <ul>
					<li>Added names, not keys to Pet Feed List. Added commas.</li>
                </ul>
            </li>		
	        <li>Bug Fixes:
                <ul>
					<li>"Manual feed" pets even if no ideal food is available. (Thanks @Il Mago)</li>
				</ul>
            </li>
		</ul></dd>		
		<dt>1.4 - Surely I will win this Triad Bingo war<span class="date">2017-08-20</span></dt>
        <dd><ul>
	        <li>Bug Fixes:
                <ul>
					<li>Ensuring next action occurs when pet is not ready to hatch when completing Triad Bingo. (Thanks @Il Mago)</li>
				</ul>
            </li>
		</ul></dd>		
		<dt>1.3 - Spread It Out Evenly<span class="date">2017-08-19</span></dt>
        <dd><ul>
		     <li>Features:
                <ul>
					<li>Feeding Magic Potion Pets now feed evenly based on the most food type (potion type). (Thanks @therealzehner , @Il Mago)</li>
					<li>Remove description from Selling error. (Unable to easily just select eggs etc and information was not useful).</li>
					<li>Show all Sell buttons on top line.</li>
					<li>Create new columns in Eggs to determine if all Pets are generated, how many hatching spaces and what potion types can be fed. (Columns are not auto-show).</li>
				</ul> 
            </li>
	        <li>Documentation:
                <ul>
					<li>After Fed => Once Fed for better sorting.</li>
					<li>Removed information about guilds when unable to fetch user information (Bad Login).</li>
                </ul>
            </li>		
	        <li>Bug Fixes:
                <ul>
					<li>Remove error that pet can't be fed when completing triad Bingo without all the items. (Thanks @Il Mago)</li>
					<li>Re-Fetch button doesn't disable when completing triad.</li>
					<li>Required / Missing totals are now correct in Triad Bingo section. (Thanks @Il Mago)</li>
					<li>Better handling of null strings with markdown.</li>
					<li>Incorrect User Id/API does not include confusing error message about guilds.</li>
				</ul>
            </li>
		</ul></dd>		
		<dt>1.2 - We can wait without the errors<span class="date">2017-08-05</span></dt>
        <dd><ul>	
	        <li>Bug Fixes:
                <ul>
					<li>Removing the error for no pet when Triad Bingo button is used.  (Thanks @Il Mago for finding this)</li>
					<li>Typo responses.  (Thanks @katzalina for finding this).</li>
               </ul>
            </li>
		</ul></dd>	
		<dt>1.1 - 3! Goodness me! Bingo!<span class="date">2017-08-04</span></dt>
        <dd><ul>
	        <li>Documentation:
                <ul>
					<li>Added warning when completing Triad Bingo it may take over 20 minutes.</li>
                </ul>
            </li>		
	        <li>Bug Fixes:
                <ul>
					<li>Triad Bingo now works if you are hatching -> Feeding -> hatching. (Use to skip the feeding)</li>
					<li>Triad Bingo and Re-Fetch Data button disables when completing Triad Bingo to avoid issues. (Not fool proof but stops the stray click).</li>
					<li>Manual Feed now actually uses the food you specified. (The computer does not always know better)</li>
					<li>Version information now shows after fetching data.</li>
               </ul>
            </li>
		</ul></dd>	
		<dt>1.0 - Public Release<span class="date">2017-08-03</span></dt>
        <dd><ul>
            <li>Features:
                <ul>
					<li class="subheading">Sell Items</li>
					<li>Triad Bingo hatch/feed button now appears regardless if the user has all items available.</li>
					<li>Give the user the ability to show images of pets/eggs/potions and food where appropriate.</li>
				</ul> 
            </li>
	        <li>Documentation:
                <ul>
					<li>Added more description to each of the sections.</li>
					<li>Change type in Pets to match the description used in game.</li>
					<li>Eggs section always shows zero when the user has no eggs.</li>
					<li>Potions section always shows zero when the user has no food or potions.</li>
					<li>Pets section always shows zero when the user has no food but can feed pet.</li>
					<li>Expanded the name in Triad Bingo to make it clear what you are looking for.</li>
					<li>Rearrange of sections, columns as required</li>
                </ul>
            </li>		
	        <li>Bug Fixes:
                <ul>
					<li>Triad Bingo now shows items that are missing if the user has none.</li>
					<li>documentation / options always shows next to the re-fetch button</li>
					<li>Typo options</li>
               </ul>
            </li>
		</ul></dd>	
        <dt>0.1 - Beta Release <span class="date">2017-08-01</span></dt>
        <dd><ul>
            <li>Features:
                <ul>
                    <li class="subheading">Pets Section</li>
					<li class="subheading">Triad Bingo Section</li>
					<li class="subheading">Activity Log Section</li>
					<li class="subheading">Eggs Section</li>
					<li class="subheading">Potion Section</li>
					<li>Bulk feeding pets selected with food desired</li>
					<li>Bulk hatching pets</li>
					<li>Manually feeding pets with food</li>
					<li>Completing Triad Bingo with one button</li>
                </ul>
            </li>
            <li>Documentation:
                <ul>
                    <li>Spoiler Note</li>
					<li>Privacy and security notes (also related comments within the code)</li>
                    <li>What's On This Page? (descriptions of each feature)</li>
                    <li>Possible Future Features</li>
                    <li>Suspected Bugs (no support for old browsers; mobile support unknown)</li>
                    <li>Help and Contact Details</li>
                </ul>
            </li>
        </ul></dd>
    </dl>
    <div class="showHideToggle closer" data-target="versionChanges" data-scrolltotop="true">close version history <span class="lowlight">(or click the version number again to close)</span></div>
    <hr />
</div><!-- end of div id="versionChanges" -->


<div id="DASHBOARD"></div>
<div id="TOC"></div>
<div id="MAIN"></div>

<div id="documentationAndForm">
   <p>This page shows you certain information from your <a
   href="https://habitica.com/">Habitica</a> account. You can read the
   full list below, or just enter your details and try it out.</p>

   <p class="spoiler">SPOILERS AHEAD!!!<br />
   This site contains spoiler information for pets & food etc.<br />
   Please do not use if you are new to Habitica.</p>
  
   
    <iframe src="js/null.htm" id="formPasswdSaveFix" name="formPasswdSaveFix" style="display:none"></iframe><!-- DAMN YOU CHROME!! DAMN YOU!!!! http://stackoverflow.com/a/9116737 -->
    <form id="userApiDetailsForm" method="POST" action="" target="formPasswdSaveFix">
        <fieldset>
            <legend><span class="highlight">Enter your Habitica API details</span>
            (from the <a href="https://habitica.com/user/settings/api">Settings
             -&gt; API page</a>)
            </legend>
            <label for="userId"><span>User ID</span>
                <input type="text" name="userId" id="userId"/>
            </label>
            <label for="apiToken"><span>API Token</span>
                <input type="password" name="apiToken" id="apiToken"/>
            </label>
			<label for="showImage"><span>Show Images?</span>
                <input type="checkbox" name="showImage" id="showImage"/>
            </label>
			<div id="exportOptionSelector"></div>
            <input class="div-fetchData" type="submit" value="Fetch Pet Data" />
			<div id="exportOptionDesc"></div>
            <p class="highlight">Privacy and security notes:</p>
            <ul>
            <!--<li>If you access this page from the Data menu on the Habitica
            website, your User ID will be automatically added to the form
            above.</li> $$$ Maybe one day when the tool that good--->
            <li>Your API Token is a password - do not share it with anyone,
            not even the maintainer of this page if you are seeking help.</li>
            <li>When you enter your User ID and API Token here and click
            "Fetch My Data", your ID and Token are sent to Habitica's servers.
            They are not sent anywhere else.
            To confirm that, you can ask someone who knows the JavaScript
            programming language to examine the source of this page.</li>
            <li>This page does not save your User ID and API Token to any
            location, but your browser might, if it has been configured to
            save form and password information. If you are using this page
            on a shared computer, you should clear any data that the browser
            has saved.</li>
            <li>You cannot view anyone else's private data by using this page.</li>
            <li>To clear your data, reload the page.</li>
            </ul>
        </fieldset>
    </form>


    <div>
		<h2>What's On This Page?</h2>
		<ul>
			<div id="sectionDesc"></div>
		</ul>		
		<h2>Possible Future Features</h2>
		<ul>
			<li>Column Filtering (as opposed to single search box)</li>
			<li><span class="subheading">Other Stuff?</span>: Send me ideas! Contact details are below.</li>
		</ul>

		<h2>Known Bugs</h2>
		<p>The hiding and closing of sections is a bit funky. (One day I will fix it but not today.)</p>

		<p>Internet Explorer will produce odd results if you use the "Re-Fetch Data" button. Reloading the page will fix the problem. Avoid using that button. Avoiding Internet Explorer will also work.</p>
		<p>This page will not work correctly on old browsers because it uses modern website features and relies on compliance to standards (both can be lacking in old browsers). <a href="http://browsehappy.com/">Updating your browser is important for general safety on the Internet!</a> If you have upgraded your browser to the latest version and are still having problems, please tell me! Contact details are below.</p>
		<p>Regardless of what bugs there might be, the only changes that could result in any changes being made on your Habitica account are with Pets, Mounts, Food, Potions and Eggs.</p>

		<h2>Thank You!</h2>
		<p>Thank you to @Alys & Ryan for their code which this is based. Thank you to the brave and mighty testers in the <a href="https://habitica.com/groups/guild/d9a0ec1e-352b-4697-a5d5-fb45c98fb4a3">Testing & Bug Squashing for Dragon Tools</a>; your willingness to dive into the murky waters of beta testing makes these tools better.<p> 

		<h2>Help and Contact Details</h2>
		<p>This page has been created by <a href="http://habitica.wikia.com/wiki/User:CTheDragons">cTheDragons</a>. If you have questions, problems, or suggestions, you're welcome to contact me, although I cannot guarantee that I'll always be able to spend a lot of time on this. You can contact me at <a href="https://habitica.com/groups/guild/d9a0ec1e-352b-4697-a5d5-fb45c98fb4a3">Testing & Bug Squashing for Dragon Tools</a>. I tend to ignore emails & PMs.</p>
		<p>Code can be source at  <a href="https://github.com/cTheDragons/Habitica-Bulk-Feed">Github<a>. Contributions are welcome. As already stated, any issues please report to  <a href="https://habitica.com/groups/guild/d9a0ec1e-352b-4697-a5d5-fb45c98fb4a3">Testing & Bug Squashing for Dragon Tools</a> for a faster response and to avoid duplication. </p>
		<p>If you have general questions about Habitica, post them to <a href="https://habitica.com/groups/tavern">Tavern</a> or <a href="https://habitica.com/groups/guild/5481ccf3-5d2d-48a9-a871-70a7380cee5a">Habitica Help: Ask a Question Guild</a>.</p>
    </div>
	
	<div id="documentationAndFormClose" class="showHideToggle closer" data-target="documentationAndForm" data-resettoggletext="documentationAndFormToggle">hide documentation / options</div>
	
</div><!-- end of div id="documentationAndForm" -->
	
</div><!-- end of div id="innerBody" -->
</body>
</html>